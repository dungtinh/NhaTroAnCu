@model NhaTroAnCu.Models.Room
@{
    ViewBag.Title = "Chi tiết phòng " + Model.Name;
    var now = DateTime.Now;
    var currentMonth = now.Month;
    var currentYear = now.Year;
    var contract = Model.Contracts?.FirstOrDefault(c => c.Status == "Active");
    var bill = Model.UtilityBills?.FirstOrDefault(b => b.Month == currentMonth && b.Year == currentYear);
    var payments = Model.PaymentHistories?.Where(p => p.Month == currentMonth && p.Year == currentYear).ToList() ?? new List<NhaTroAnCu.Models.PaymentHistory>();
    decimal paidTotal = payments.Sum(x => x.TotalAmount);
    decimal billTotal = bill?.TotalAmount ?? 0;
    decimal debt = billTotal - paidTotal;
    var prevBill = Model.UtilityBills?.OrderByDescending(b => b.Year).ThenByDescending(b => b.Month)
        .FirstOrDefault(b => (b.Month == (currentMonth == 1 ? 12 : currentMonth - 1)) && (b.Year == (currentMonth == 1 ? currentYear - 1 : currentYear)));
    int waterPrev = prevBill?.WaterIndexEnd ?? 0;
    decimal waterPrice = contract?.WaterPrice ?? 15000;
    decimal rentPrice = contract?.PriceAgreed ?? Model.DefaultPrice;
    bool isNearingEnd = contract != null &&
        (contract.EndDate - DateTime.Now).TotalDays > 0 &&
        (contract.EndDate - DateTime.Now).TotalDays <= 31;
}

<!-- HEADER & INFO -->
<h2 class="mb-3">Phòng @Model.Name</h2>
<div class="row">
    <div class="col-md-5">
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">Tiện ích & Thông tin phòng</div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>Giá mặc định: @Model.DefaultPrice.ToString("N0")</li>
                    <li>Điều hòa: @(Model.HasAirCondition ? "Có" : "Không")</li>
                    <li>Tủ lạnh: @(Model.HasFridge ? "Có" : "Không")</li>
                    <li>Bình lọc nước: @(Model.HasWaterHeater? "Có" : "Không")</li>
                    <li>Giường: @(Model.HasBed? "Có" : "Không")</li>
                    <li>Tủ: @(Model.HasWardrobe? "Có" : "Không")</li>
                </ul>
            </div>
        </div>
        @if (contract != null)
        {
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">Thông tin hợp đồng & khách thuê</div>
                @if (contract != null)
                {
                    if (isNearingEnd)
                    {
                        <div class="alert alert-warning d-inline-block p-2 mb-2" style="font-size: 1em; margin-top: 10px;">
                            <i class="fa fa-exclamation-triangle"></i>
                            Hợp đồng sắp hết hạn vào: <b>@contract.EndDate.ToString("dd/MM/yyyy")</b>
                        </div>
                    }
                    <!-- Các thông tin hợp đồng tiếp -->
                }
                <div class="card-body">
                    <div>
                        <p>Giá thuê thực tế: @contract.PriceAgreed.ToString("N0")</p>
                        <p>Đặt cọc: @contract.DepositAmount.ToString("N0")</p>
                        <p>Ngày vào: @contract.MoveInDate.ToString("dd/MM/yyyy")</p>
                        <p>Ngày ký HĐ: @contract.StartDate.ToString("dd/MM/yyyy")</p>
                        <p>Ngày hạn hợp đồng: <b>@(contract.EndDate.ToString("dd/MM/yyyy") )</b></p>
                    </div>

                    <!-- Gia hạn hợp đồng -->
                    @if (contract.Status == "Active")
                    {
                        <div class="mb-3 mt-2">
                            <form id="extendContractForm" class="row align-items-center" style="gap:8px;">
                                @Html.Hidden("contractId", contract.Id)
                                <div class="col-auto">
                                    <label for="extendMonths" class="col-form-label font-weight-bold mr-2" style="font-size:1rem;">Gia hạn:</label>
                                </div>
                                <div class="col-auto">
                                    <input type="number" min="1" max="36" class="form-control form-control-sm d-inline-block" id="extendMonths" name="extendMonths" value="12" style="width:70px;" />
                                </div>
                                <div class="col-auto">
                                    <span style="min-width:40px;">tháng</span>
                                </div>
                                <div class="col-auto">
                                    <input type="text" class="form-control form-control-sm" name="note" placeholder="Ghi chú (tuỳ chọn)" style="width:160px;" />
                                </div>
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-primary btn-sm px-3">Gia hạn</button>
                                </div>
                                <div class="col-auto">
                                    <span id="extendResult" class="text-success ml-2" style="font-size:0.96em;"></span>
                                </div>
                            </form>
                        </div>
                        @* Hiển thị lịch sử gia hạn *@
                        var extensionLogs = contract.ContractExtensionHistories?
                            .OrderByDescending(x => x.ExtendedAt)
                            .ToList() ?? new List<NhaTroAnCu.Models.ContractExtensionHistory>();

                        if (extensionLogs.Any())
                        {
                            <div class="mt-3">
                                <h6>Lịch sử gia hạn hợp đồng:</h6>
                                <table class="table table-bordered table-sm">
                                    <thead>
                                        <tr>
                                            <th>Thời gian gia hạn</th>
                                            <th>Thời hạn cũ</th>
                                            <th>Thời hạn mới</th>
                                            <th>Số tháng gia hạn</th>
                                            <th>Ghi chú</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var log in extensionLogs)
                                        {
                                            <tr>
                                                <td>@log.ExtendedAt.ToString("dd/MM/yyyy")</td>
                                                <td>@(log.OldEndDate.HasValue ? log.OldEndDate.Value.ToString("dd/MM/yyyy") : "-")</td>
                                                <td>@(log.NewEndDate.HasValue ? log.NewEndDate.Value.ToString("dd/MM/yyyy") : "-")</td>
                                                <td>@log.ExtendMonths</td>
                                                <td>@log.Note</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    }
                    <ul style="list-style: none; padding-left:0;">
                        @foreach (var ct in contract.ContractTenants)
                        {
                            <li>
                                @ct.Tenant.FullName -
                                <a href="https://zalo.me/@ct.Tenant.PhoneNumber" target="_blank" title="Chat Zalo">
                                    <img src="https://stc-zaloprofile.zdn.vn/pc/v1/images/zalo_sharelogo.png" style="height:20px;width:20px;vertical-align:middle;margin-right:4px;" />
                                    @ct.Tenant.PhoneNumber
                                </a>
                            </li>
                        }
                    </ul>
                    <div class="mb-2">
                        @foreach (var ct in contract.ContractTenants)
                        {
                            <img src="@ct.Tenant.Photo" width="100" style="margin-right: 6px; margin-bottom: 6px; border-radius:6px;border:1px solid #ccc;" title="@ct.Tenant.FullName" />
                        }
                    </div>
                    <div>
                        <a href="@Url.Action("Edit", "Contracts", new { id = contract.Id })" class="btn btn-warning btn-sm">Sửa hợp đồng</a>
                        <a href="@Url.Action("ExportContract", "Contracts", new { id = contract.Id })" target="_blank" class="btn btn-primary btn-sm">Bộ giấy tờ thuê nhà</a>
                        @using (Html.BeginForm("UploadContractScan", "Contracts", FormMethod.Post, new { enctype = "multipart/form-data", style = "display:inline" }))
                        {
                            @Html.Hidden("contractId", contract.Id)
                            <label for="scanFile" class="btn btn-secondary btn-sm">Upload HĐ đã scan</label>
                            <input type="file" id="scanFile" name="scanFile" accept=".pdf,.jpg,.jpeg,.png" style="display:none;" onchange="this.form.submit()" />
                        }
                        @if (!string.IsNullOrEmpty(contract.ContractScanFilePath))
                        {
                            <a href="@Url.Content(contract.ContractScanFilePath)" target="_blank" class="btn btn-info btn-sm">Xem hợp đồng scan</a>
                        }
                        <a href="#" class="btn btn-danger btn-sm" title="Kết thúc hợp đồng"
                           onclick="return confirm('Bạn có chắc muốn kết thúc hợp đồng hiện tại?') ? (window.location.href='@Url.Action("End", "Contracts", new { id = contract.Id })', false) : false;">Kết thúc hợp đồng</a>
                    </div>
                </div>
            </div>
        }
    </div>
    <div class="col-md-7">
        <!-- MODAL TẠO/SỬA PHIẾU BÁO TIỀN-->
        <div class="modal fade" id="utilityBillModal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title font-weight-bold">Tạo phiếu báo tiền</h5>
                        <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
                    </div>
                    <div class="modal-body p-4">
                        @{
                            var utilityBillVm = new NhaTroAnCu.Models.UtilityBillCreateViewModel
                            {
                                RoomId = Model.Id,
                                ContractId = contract?.Id ?? 0,
                                Month = currentMonth,
                                Year = currentYear,
                                WaterIndexStart = waterPrev,
                                WaterPrice = waterPrice,
                                RentAmount = rentPrice,
                                WaterIndexEnd = bill?.WaterIndexEnd ?? waterPrev,
                                ElectricityAmount = bill?.ElectricityAmount ?? 0,
                                // Nếu đã có bill thì lấy theo bill, chưa có thì lấy theo ViewBag (tức là tháng đầu tiên)
                                ExtraCharge = bill?.ExtraCharge ?? (ViewBag.ExtraCharge ?? 0),
                                Discount = bill?.Discount ?? (ViewBag.Discount ?? 0),
                                TotalAmount = bill?.TotalAmount ?? 0,
                                BillNote = bill?.BillNote,
                                BillStatus = bill?.BillStatus
                            };
                        }
                        @Html.Partial("_CreateOrEditUtilityBillPartial", utilityBillVm)
                    </div>
                </div>
            </div>
        </div>

        <!-- HIỂN THỊ PHIẾU BÁO TIỀN HIỆN TẠI -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white font-weight-bold">
                @if (bill != null)
                {
                    <span>Phiếu báo tiền tháng @bill.Month/@bill.Year</span>
                }
                else
                {
                    <span>Chưa có phiếu báo tiền tháng này</span>
                }
                <button class="btn btn-warning" data-toggle="modal" data-target="#utilityBillModal" style="padding-top:0px; padding-bottom: 0px;">
                    @(bill != null ? "Sửa phiếu báo tiền tháng này" : "Tạo phiếu báo tiền tháng này")
                </button>
            </div>
            <div class="card-body">
                @if (bill != null)
                {
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Chỉ số nước đầu tháng</dt>
                        <dd class="col-sm-7">@bill.WaterIndexStart</dd>
                        <dt class="col-sm-5">Chỉ số nước cuối tháng</dt>
                        <dd class="col-sm-7">@bill.WaterIndexEnd</dd>
                        <dt class="col-sm-5">Tiền nước</dt>
                        <dd class="col-sm-7">@((bill.Water ?? 0).ToString("N0")) đ</dd>
                        <dt class="col-sm-5">Tiền điện</dt>
                        <dd class="col-sm-7">@((bill.ElectricityAmount ?? 0).ToString("N0")) đ</dd>
                        <dt class="col-sm-5">Tiền thuê</dt>
                        <dd class="col-sm-7">@((bill.RentAmount ?? 0).ToString("N0")) đ</dd>
                        <dt class="col-sm-5">Cộng thêm</dt>
                        <dd class="col-sm-7 text-success">@((bill.ExtraCharge ?? 0).ToString("N0")) đ</dd>
                        <dt class="col-sm-5">Giảm trừ</dt>
                        <dd class="col-sm-7 text-danger">-@((bill.Discount ?? 0).ToString("N0")) đ</dd>
                        <dt class="col-sm-5 font-weight-bold">Tổng cần thanh toán</dt>
                        <dd class="col-sm-7 text-danger font-weight-bold h5">
                            @((bill.TotalAmount ?? 0).ToString("N0")) đ
                        </dd>
                        <dt class="col-sm-5">Ghi chú</dt>
                        <dd class="col-sm-7">@bill.BillNote</dd>
                    </dl>
                }
                else
                {
                    <div class="alert alert-warning mb-0">Chưa có phiếu báo tiền tháng này.</div>
                }
            </div>
        </div>

        <!-- FORM GHI NHẬN THANH TOÁN -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">Ghi nhận thanh toán tháng @currentMonth/@currentYear</div>
            <div class="card-body">
                @if (bill != null)
                {
                    <form id="paymentForm">
                        <div class="row align-items-end">
                            <input type="hidden" name="utilityBillId" value="@bill.Id" />
                            <div class="col-md-4">
                                <label for="amount">Số tiền nhận</label>
                                <input class="form-control money" name="amount" id="amount" min="0" required />
                            </div>
                            <div class="col-md-6">
                                <label for="note">Ghi chú</label>
                                <input type="text" class="form-control" name="note" id="note" />
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-success mt-4 w-100">Ghi nhận</button>
                            </div>
                        </div>
                    </form>
                    <hr />
                    <div>
                        <span class="text-primary font-weight-bold">Đã thu: <span id="paidTotal">@paidTotal.ToString("N0")</span></span>
                        <span class="ml-3 text-danger font-weight-bold">Còn nợ: <span id="debt">@debt.ToString("N0")</span></span>
                        <span class="ml-3 font-weight-bold">Tổng cần thanh toán: <span id="totalBill">@billTotal.ToString("N0")</span></span>
                    </div>
                    <h6 class="mt-3 mb-2">Các lần thanh toán trong tháng:</h6>
                    <table class="table table-bordered table-sm">
                        <tr>
                            <th>Số tiền</th>
                            <th>Ngày thu</th>
                            <th>Ghi chú</th>
                        </tr>
                        @foreach (var p in payments.OrderByDescending(x => x.PaidDate))
                        {
                            <tr>
                                <td>@p.TotalAmount.ToString("N0")</td>
                                <td>@p.PaidDate.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>@p.Note</td>
                            </tr>
                        }
                    </table>
                }
                else
                {
                    <div class="alert alert-warning mb-0">Chưa có phiếu báo tiền tháng này. Hãy tạo phiếu báo tiền trước!</div>
                }
            </div>
        </div>
    </div>
</div>

<!-- LỊCH SỬ PHIẾU BÁO TIỀN -->
<h4 class="mt-4 mb-2">Lịch sử phiếu báo tiền</h4>
<table class="table table-bordered table-sm">
    <tr>
        <th>Tháng/Năm</th>
        <th>Tổng tiền</th>
        <th>Ghi chú</th>
    </tr>
    @foreach (var b in (Model.UtilityBills ?? new List<NhaTroAnCu.Models.UtilityBill>()).OrderByDescending(x => x.Year).ThenByDescending(x => x.Month))
    {
        <tr>
            <td>@b.Month/@b.Year</td>
            <td>@((b.TotalAmount??0).ToString("N0"))</td>
            <td>@b.BillNote</td>
        </tr>
    }
</table>

<!-- LỊCH SỬ TẤT CẢ CÁC LẦN THANH TOÁN -->
<h4 class="mt-4 mb-2">Lịch sử tất cả các lần thanh toán</h4>
<table class="table table-bordered table-sm">
    <tr>
        <th>Tháng/Năm</th>
        <th>Số tiền</th>
        <th>Ngày thu</th>
        <th>Ghi chú</th>
    </tr>
    @foreach (var p in (Model.PaymentHistories ?? new List<NhaTroAnCu.Models.PaymentHistory>()).OrderByDescending(x => x.PaidDate))
    {
        <tr>
            <td>@p.Month/@p.Year</td>
            <td>@p.TotalAmount.ToString("N0")</td>
            <td>@p.PaidDate.ToString("dd/MM/yyyy HH:mm")</td>
            <td>@p.Note</td>
        </tr>
    }
</table>

@section Scripts {
    <script>
        // AJAX tạo/sửa phiếu báo tiền
        $('#utilityBillForm').submit(function (e) {
            e.preventDefault();
            var form = $(this);
            var data = form.serialize();
            $.post('/UtilityBills/CreateOrUpdateAjax', data, function (res) {
                if (res.success) {
                    alert('Đã lưu phiếu báo tiền!');
                    location.reload();
                } else {
                    alert('Lỗi: ' + res.message);
                }
            });
        });

        // AJAX ghi nhận thanh toán
        $('#paymentForm').submit(function (e) {
            e.preventDefault();
            var form = $(this);
            var data = form.serialize();
            $.post('/Payments/CollectPayment', data, function (res) {
                if (res.success) {
                    alert('Ghi nhận thanh toán thành công!');
                    location.reload();
                } else {
                    alert('Có lỗi xảy ra!');
                }
            });
        });
        $('.btn-warning[data-toggle="modal"]').click(function () {
            $('#utilityBillModal').modal('show');
        });
        $('#extendContractForm').submit(function (e) {
        e.preventDefault();
        var form = $(this);
        var extendMonths = form.find('input[name="extendMonths"]').val();
        var note = form.find('input[name="note"]').val();
        var contractId = form.find('input[name="contractId"]').val();

        // --- Xác nhận trước khi gửi ---
        if (!confirm('Bạn có chắc muốn gia hạn hợp đồng thêm ' + extendMonths + ' tháng?')) {
            return;
        }

        $.post('@Url.Action("ExtendContract", "Contracts")', {
            contractId: contractId,
            extendMonths: extendMonths,
            note: note
        }, function (res) {
            if (res.success) {
                $('#extendResult').text('Gia hạn thành công! HĐ mới hết hạn: ' + res.newEndDate);
                location.reload();
            } else {
                $('#extendResult').text('Lỗi: ' + (res.message || 'Không xác định'));
            }
        });
    });
    </script>
    <script src="~/Scripts/Scripts_TaoPhieuBaoTien.js"></script>
}