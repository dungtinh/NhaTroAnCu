﻿@{
    ViewBag.Title = "Báo cáo thu chi";
    var transactions = ViewBag.Transactions as List<NhaTroAnCu.Models.IncomeExpens>;
    // Không ép kiểu, dùng trực tiếp ViewBag.ExpenseChartData
}

<div class="container">
    <div class="row">
        <!-- Bên trái: Report Header + Summary -->
        <div class="col-md-8">
            <div class="report-header">
                <h2><i class="fas fa-chart-line"></i> Báo cáo thu chi tháng @ViewBag.Month/@ViewBag.Year</h2>
                <form method="get" class="form-inline">
                    <select name="month" class="form-control mr-2" style="display: inline-block; width: 100px;">
                        @for (int m = 1; m <= 12; m++)
                        {
                            <option value="@m" @(m == ViewBag.Month ? "selected" : "")>Tháng @m</option>
                        }
                    </select>
                    <select name="year" class="form-control mr-2" style="display: inline-block; width: 100px;">
                        @for (int y = DateTime.Now.Year - 2; y <= DateTime.Now.Year + 1; y++)
                        {
                            <option value="@y" @(y == ViewBag.Year ? "selected" : "")>@y</option>
                        }
                    </select>
                    <button type="submit" class="btn btn-primary" style="display: inline-block; width: 100px;">
                        <i class="fas fa-search"></i> Xem
                    </button>
                </form>
            </div>
            <div class="row summary-boxes">
                <div class="col-md-4">
                    <div class="summary-box income">
                        <h4>Tổng thu</h4>
                        <p class="amount">+@ViewBag.TotalIncome.ToString("N0") đ</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="summary-box expense">
                        <h4>Tổng chi</h4>
                        <p class="amount">-@ViewBag.TotalExpense.ToString("N0") đ</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="summary-box balance @(ViewBag.Balance >= 0 ? "positive" : "negative")">
                        <h4>Cân đối</h4>
                        <p class="amount">@ViewBag.Balance.ToString("N0") đ</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- Bên phải: Biểu đồ các loại chi -->
        <div class="col-md-4 d-flex align-items-start">
            <div class="w-100">
                <h4 class="mb-3"><i class="fas fa-chart-pie"></i> Biểu đồ phân bổ các loại chi</h4>
                <div style=" padding: 0 10rem;">
                    <canvas id="expenseCategoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Details giữ nguyên phía dưới -->
    <div class="transaction-details mt-4">
        <h4>Chi tiết giao dịch</h4>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Ngày</th>
                    <th>Danh mục</th>
                    <th>Mô tả</th>
                    <th>Thu</th>
                    <th>Chi</th>
                    <th>Số dư</th>
                </tr>
            </thead>
            <tbody>
                @{
                    decimal balance = 0;
                    foreach (var trans in transactions)
                    {
                        if (trans.IncomeExpenseCategory.Type == "Income")
                        {
                            balance += trans.Amount;
                        }
                        else
                        {
                            balance -= trans.Amount;
                        }
                        <tr>
                            <td>@trans.TransactionDate.ToString("dd/MM")</td>
                            <td>@trans.IncomeExpenseCategory.Name</td>
                            <td>@trans.Description</td>
                            <td class="text-success">
                                @(trans.IncomeExpenseCategory.Type == "Income" ? trans.Amount.ToString("N0") : "")
                            </td>
                            <td class="text-danger">
                                @(trans.IncomeExpenseCategory.Type == "Expense" ? trans.Amount.ToString("N0") : "")
                            </td>
                            <td class="font-weight-bold @(balance >= 0 ? "text-primary" : "text-danger")">
                                @balance.ToString("N0")
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Dữ liệu chart các loại chi từ ViewBag (không ép kiểu)
    var expenseChartData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.ExpenseChartData ?? new List<dynamic>()));
    var labels = (expenseChartData && expenseChartData.length > 0) ? expenseChartData.map(x => x.Category) : [];
    var data = (expenseChartData && expenseChartData.length > 0) ? expenseChartData.map(x => x.TotalAmount) : [];

    if(labels.length > 0 && data.length > 0) {
        var ctx = document.getElementById('expenseCategoryChart').getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Phân bổ chi',
                    data: data,
                    backgroundColor: [
                        '#dc3545', '#ffc107', '#17a2b8', '#6f42c1', '#28a745', '#007bff', '#fd7e14', '#20c997', '#6610f2', '#e83e8c'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'right' }
                }
            }
        });
    }
</script>
<link href="~/Content/income-report.css" rel="stylesheet" />