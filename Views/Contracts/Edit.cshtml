@model NhaTroAnCu.Models.ContractEditViewModel

@{
    ViewBag.Title = "Sửa hợp đồng";
}
<link href="~/Content/contract-action.css" rel="stylesheet" />
<div class="edit-contract-container">
    <div class="page-header">
        <h2><i class="fas fa-edit"></i> Sửa hợp đồng thuê phòng</h2>
    </div>

    @using (Html.BeginForm("Edit", "Contracts", FormMethod.Post, new { enctype = "multipart/form-data" }))
    {
        @Html.AntiForgeryToken()
        @Html.HiddenFor(m => m.Id)

        <!-- Contract Information -->
        <div class="edit-card">
            <div class="section-title">
                <i class="fas fa-file-contract"></i>
                Thông tin hợp đồng
            </div>

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label><i class="fas fa-door-open"></i> Phòng</label>
                    @Html.HiddenFor(m => m.RoomId)
                    @Html.DropDownListFor(m => m.RoomId, (SelectList)ViewBag.RoomList, "Chọn phòng", new { @class = "form-control readonly-field", disabled = "disabled" })
                    <small class="text-muted"><i class="fas fa-lock"></i> Không thể thay đổi phòng khi sửa hợp đồng</small>
                </div>
                <div class="form-group col-md-3">
                    <label><i class="fas fa-calendar-alt"></i> Ngày bắt đầu</label>
                    @Html.TextBoxFor(m => m.MoveInDate, "{0:dd/MM/yyyy}", new { @class = "form-control readonly-field", @readonly = "readonly" })
                    <small class="text-muted"><i class="fas fa-lock"></i> Không thể thay đổi</small>
                </div>
                <div class="form-group col-md-3">
                    <label><i class="fas fa-clock"></i> Số tháng thuê</label>
                    @Html.TextBoxFor(m => m.Months, new { @class = "form-control", type = "number", min = 1 })
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label><i class="fas fa-money-bill-wave"></i> Giá thương lượng</label>
                    @Html.TextBoxFor(m => m.PriceAgreed, new { @class = "form-control money" })
                </div>
                <div class="form-group col-md-6">
                    <label><i class="fas fa-piggy-bank"></i> Tiền đặt cọc</label>
                    @Html.TextBoxFor(m => m.DepositAmount, new { @class = "form-control money" })
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label><i class="fas fa-bolt"></i> Giá điện (VNĐ/kWh)</label>
                    @Html.TextBoxFor(m => m.ElectricityPrice, new { @class = "form-control money" })
                </div>
                <div class="form-group col-md-6">
                    <label><i class="fas fa-tint"></i> Giá nước (VNĐ/m³)</label>
                    @Html.TextBoxFor(m => m.WaterPrice, new { @class = "form-control money" })
                </div>
            </div>
        </div>

        <!-- Tenant Information -->
        <div class="edit-card">
            <div class="section-title">
                <i class="fas fa-users"></i>
                Thông tin người thuê
            </div>

            <div id="tenantList">
                @for (int i = 0; i < Model.Tenants.Count; i++)
                {
                    <div class="tenant-card" data-tenant-index="@i">
                        @Html.HiddenFor(m => m.Tenants[i].Id)
                        <div class="tenant-card-header">
                            <span><i class="fas fa-user"></i> Người thuê #@(i + 1)</span>
                            @if (Model.Tenants.Count > 1)
                            {
                                <button type="button" class="remove-tenant">
                                    <i class="fas fa-trash"></i> Xóa
                                </button>
                            }
                        </div>
                        <div class="tenant-card-body">
                            <!-- Enhanced Photo Section -->
                            <div class="photo-section">
                                @if (!string.IsNullOrEmpty(Model.Tenants[i].Photo))
                                {
                                    <div class="current-photos">
                                        <h6><i class="fas fa-images"></i> Giấy tờ hiện tại - @Model.Tenants[i].FullName</h6>
                                        <div class="photo-grid">
                                            @{
                                                var photos = Model.Tenants[i].Photo.Split(';');
                                                var tenantIndex = i;
                                                foreach (var photo in photos.Where(p => !string.IsNullOrWhiteSpace(p)))
                                                {
                                                    <div class="photo-thumbnail" onclick="showPhotoModal('@photo', @tenantIndex)">
                                                        <img src="@Url.Content(photo)"
                                                             alt="Giấy tờ người thuê @(tenantIndex + 1)"
                                                             loading="lazy" />
                                                    </div>
                                                }
                                            }
                                        </div>
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle"></i> Click vào ảnh để xem chi tiết. Chọn file mới sẽ thay thế tất cả ảnh hiện tại.
                                        </small>
                                    </div>
                                }
                                else
                                {
                                    <div class="no-photo">
                                        <i class="fas fa-image"></i>
                                        <p>Chưa có giấy tờ</p>
                                    </div>
                                }

                                <!-- Upload new photos -->
                                <div class="upload-section">
                                    <h6>
                                        <i class="fas fa-upload"></i> Upload giấy tờ mới cho người thuê #@(i + 1)
                                    </h6>

                                    <div class="mb-3">
                                        <label for="inputFile@(i)" class="btn-upload">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            Chọn file (có thể chọn nhiều)
                                        </label>
                                        <input type="file"
                                               id="inputFile@(i)"
                                               name="TenantPhotos"
                                               accept=".jpg,.jpeg,.png"
                                               style="display: none;"
                                               multiple
                                               data-tenant-index="@i" />
                                    </div>

                                    <div id="fileInfo@(i)" class="file-info" style="display: none;">
                                        <i class="fas fa-file-image"></i>
                                        <span id="fileCount@(i)">0</span> file đã chọn cho người thuê #@(i + 1)
                                    </div>

                                    <div id="fileList@(i)" class="file-list"></div>

                                    <div class="mt-3 d-flex gap-2">
                                        <button type="button" id="btn@(i)" name="uploadButton" class="btn btn-primary btn-sm">
                                            <i class="fas fa-id-card-alt"></i> Quét thông tin
                                        </button>
                                        <button type="button" onclick="clearTenantFiles(@i)" class="btn btn-secondary btn-sm">
                                            <i class="fas fa-times"></i> Xóa tất cả
                                        </button>
                                    </div>

                                    <div id="loading@(i)" style="display:none;" class="mt-2">
                                        <i class="fas fa-spinner loading-spinner"></i> Đang xử lý...
                                    </div>
                                    <div id="results@(i)"></div>
                                </div>
                            </div>

                            <!-- Personal Information -->
                            <div class="form-row mt-4">
                                <div class="form-group col-md-6">
                                    <label><i class="fas fa-signature"></i> Họ tên</label>
                                    @Html.TextBoxFor(m => m.Tenants[i].FullName, new { @class = "form-control", required = "required" })
                                </div>
                                <div class="form-group col-md-6">
                                    <label><i class="fas fa-id-card"></i> Số CCCD</label>
                                    @Html.TextBoxFor(m => m.Tenants[i].IdentityCard, new { @class = "form-control", required = "required" })
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group col-md-4">
                                    <label><i class="fas fa-phone"></i> Điện thoại</label>
                                    @Html.TextBoxFor(m => m.Tenants[i].PhoneNumber, new { @class = "form-control" })
                                </div>
                                <div class="form-group col-md-4">
                                    <label><i class="fas fa-birthday-cake"></i> Ngày sinh</label>
                                    @Html.TextBoxFor(m => m.Tenants[i].BirthDate, "{0:dd/MM/yyyy}", new { @class = "form-control datepicker" })
                                </div>
                                <div class="form-group col-md-4">
                                    <label><i class="fas fa-venus-mars"></i> Giới tính</label>
                                    @Html.DropDownListFor(m => m.Tenants[i].Gender,
                                        new SelectList(new[] { "Nam", "Nữ", "Khác" }, Model.Tenants[i].Gender),
                                        "Chọn giới tính", new { @class = "form-control" })
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label><i class="fas fa-users"></i> Dân tộc</label>
                                    @Html.TextBoxFor(m => m.Tenants[i].Ethnicity, new { @class = "form-control", placeholder = "VD: Kinh" })
                                </div>
                                <div class="form-group col-md-6">
                                    <label><i class="fas fa-motorcycle"></i> Biển số xe</label>
                                    @Html.TextBoxFor(m => m.Tenants[i].VehiclePlate, new { @class = "form-control", placeholder = "VD: 15H1-12345" })
                                </div>
                            </div>

                            <div class="form-group">
                                <label><i class="fas fa-home"></i> Nơi thường trú</label>
                                @Html.TextBoxFor(m => m.Tenants[i].PermanentAddress, new { @class = "form-control" })
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="action-buttons">
                <button type="button" class="btn btn-outline-secondary btn-custom" onclick="addTenant()">
                    <i class="fas fa-plus"></i> Thêm người thuê
                </button>
                <button type="submit" class="btn btn-primary btn-custom">
                    <i class="fas fa-save"></i> Lưu thay đổi
                </button>
                @Html.ActionLink("Quay lại", "Index", "Rooms", null, new { @class = "btn btn-outline-secondary btn-custom" })
            </div>
        </div>
    }
</div>

<!-- Enhanced Photo Modal -->
<div class="modal fade" id="photoModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="photoModalTitle">
                    <i class="fas fa-image"></i> Xem giấy tờ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                </button>
            </div>
            <div class="modal-body text-center">
                <img id="modalPhoto" src="" alt="Giấy tờ" />
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Enhanced photo modal with better sizing
        function showPhotoModal(photoUrl, tenantIndex) {
            $('#modalPhoto').attr('src', photoUrl);
            $('#photoModalTitle').text('Giấy tờ - Người thuê #' + (tenantIndex + 1));
            $('#photoModal').modal('show');
        }

        // Clear all files for a specific tenant
        function clearTenantFiles(tenantIndex) {
            const fileInput = document.getElementById("inputFile" + tenantIndex);
            const fileInfo = $("#fileInfo" + tenantIndex);
            const fileList = $("#fileList" + tenantIndex);

            if (fileInput) {
                fileInput.value = '';
                fileInfo.hide();
                fileList.empty();
            }
        }

        // Enhanced file selection handling with proper tenant association
        $(document).on('change', 'input[type="file"][name="TenantPhotos"]', function() {
            var tenantIndex = $(this).attr('data-tenant-index') || this.id.replace("inputFile", "");
            var files = this.files;
            var fileInfo = $("#fileInfo" + tenantIndex);
            var fileList = $("#fileList" + tenantIndex);

            fileList.empty();

            if (files && files.length > 0) {
                fileInfo.show();
                $("#fileCount" + tenantIndex).text(files.length);

                for (let i = 0; i < files.length; i++) {
                    var fileSize = (files[i].size / 1024).toFixed(1) + " KB";
                    fileList.append(`
                        <div class="file-item">
                            <span>
                                <i class="fas fa-file-image text-primary"></i>
                                ${files[i].name} (${fileSize})
                                <small class="text-muted">- Người thuê #${parseInt(tenantIndex) + 1}</small>
                            </span>
                            <button type="button" onclick="removeFile(${tenantIndex}, ${i})" title="Xóa file này">×</button>
                        </div>
                    `);
                }
            } else {
                fileInfo.hide();
                $("#fileCount" + tenantIndex).text("0");
            }
        });

        // Enhanced file removal with DataTransfer support
        function removeFile(inputIndex, fileIndex) {
            var input = document.getElementById("inputFile" + inputIndex);

            if (!input.files || fileIndex >= input.files.length) {
                return;
            }

            try {
                var dt = new DataTransfer();

                // Copy all files except the one to remove
                for (let i = 0; i < input.files.length; i++) {
                    if (i !== fileIndex) {
                        dt.items.add(input.files[i]);
                    }
                }

                // Update the input
                input.files = dt.files;

                // Trigger change event to update display
                $(input).trigger('change');
            } catch (e) {
                // Fallback: show message if DataTransfer not supported
                Swal.fire({
                    icon: 'info',
                    title: 'Không thể xóa file riêng lẻ',
                    text: 'Trình duyệt không hỗ trợ. Vui lòng chọn lại tất cả file.',
                    confirmButtonText: 'Đã hiểu'
                });
            }
        }

        // Enhanced addTenant function for Edit view
        function addTenant() {
            const index = $('#tenantList .tenant-card').length;
            const html = `
                <div class="tenant-card" data-tenant-index="${index}">
                    <input type="hidden" name="Tenants[${index}].Id" value="0" />
                    <div class="tenant-card-header">
                        <span><i class="fas fa-user"></i> Người thuê #${index + 1}</span>
                        <button type="button" class="remove-tenant">
                            <i class="fas fa-trash"></i> Xóa
                        </button>
                    </div>
                    <div class="tenant-card-body">
                        <div class="photo-section">
                            <div class="no-photo">
                                <i class="fas fa-image"></i>
                                <p>Người thuê mới - chưa có giấy tờ</p>
                            </div>

                            <div class="upload-section">
                                <h6 style="font-size: 16px; font-weight: 600; margin-bottom: 15px;">
                                    <i class="fas fa-upload"></i> Upload giấy tờ cho người thuê #${index + 1}
                                </h6>
                                <label for="inputFile${index}" class="btn-upload">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    Chọn file (có thể chọn nhiều)
                                </label>
                                <input type="file"
                                       id="inputFile${index}"
                                       name="TenantPhotos"
                                       accept=".jpg,.jpeg,.png"
                                       style="display: none;"
                                       multiple
                                       data-tenant-index="${index}" />

                                <div id="fileInfo${index}" class="file-info" style="display: none;">
                                    <i class="fas fa-file-image"></i>
                                    <span id="fileCount${index}">0</span> file đã chọn
                                </div>

                                <div id="fileList${index}" class="file-list"></div>

                                <div class="mt-2">
                                    <button type="button" id="btn${index}" name="uploadButton" class="btn btn-primary btn-sm">
                                        <i class="fas fa-id-card-alt"></i> Quét thông tin
                                    </button>
                                    <button type="button" onclick="clearTenantFiles(${index})" class="btn btn-secondary btn-sm">
                                        <i class="fas fa-times"></i> Xóa tất cả
                                    </button>
                                </div>

                                <div id="loading${index}" style="display:none;" class="mt-2">
                                    <i class="fas fa-spinner loading-spinner"></i> Đang xử lý...
                                </div>
                                <div id="results${index}"></div>
                            </div>
                        </div>

                        <div class="form-row mt-4">
                            <div class="form-group col-md-6">
                                <label><i class="fas fa-signature"></i> Họ tên</label>
                                <input name="Tenants[${index}].FullName" class="form-control" required="required" />
                            </div>
                            <div class="form-group col-md-6">
                                <label><i class="fas fa-id-card"></i> Số CCCD</label>
                                <input name="Tenants[${index}].IdentityCard" class="form-control" required="required" />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label><i class="fas fa-phone"></i> Điện thoại</label>
                                <input name="Tenants[${index}].PhoneNumber" class="form-control" />
                            </div>
                            <div class="form-group col-md-4">
                                <label><i class="fas fa-birthday-cake"></i> Ngày sinh</label>
                                <input name="Tenants[${index}].BirthDate" class="form-control datepicker" placeholder="dd/MM/yyyy" />
                            </div>
                            <div class="form-group col-md-4">
                                <label><i class="fas fa-venus-mars"></i> Giới tính</label>
                                <select name="Tenants[${index}].Gender" class="form-control">
                                    <option value="">Chọn giới tính</option>
                                    <option value="Nam">Nam</option>
                                    <option value="Nữ">Nữ</option>
                                    <option value="Khác">Khác</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label><i class="fas fa-users"></i> Dân tộc</label>
                                <input name="Tenants[${index}].Ethnicity" class="form-control" placeholder="VD: Kinh" />
                            </div>
                            <div class="form-group col-md-6">
                                <label><i class="fas fa-motorcycle"></i> Biển số xe</label>
                                <input name="Tenants[${index}].VehiclePlate" class="form-control" placeholder="VD: 15H1-12345" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label><i class="fas fa-home"></i> Nơi thường trú</label>
                            <input name="Tenants[${index}].PermanentAddress" class="form-control" />
                        </div>
                    </div>
                </div>
            `;

            $('#tenantList').append(html);
            updateTenantNumbers();

            // Initialize datepicker for new tenant
            $(`input[name="Tenants[${index}].BirthDate"]`).datepicker({
                format: "dd/mm/yyyy",
                autoclose: true,
                todayHighlight: true
            });

            // Initialize scan event handler for new tenant
            AddEventReadCCCD(document.getElementById("btn" + index));
        }

        // Enhanced updateTenantNumbers for Edit view
        function updateTenantNumbers() {
            $('#tenantList .tenant-card').each(function(idx) {
                var $card = $(this);
                $card.attr('data-tenant-index', idx);
                $card.find('.tenant-card-header span').html(`<i class="fas fa-user"></i> Người thuê #${idx + 1}`);

                // Update upload section title
                $card.find('.upload-section h6').html(`
                    <i class="fas fa-upload"></i> Upload giấy tờ cho người thuê #${idx + 1}
                `);

                // Update all input names and IDs
                $card.find('input, select').each(function() {
                    var $input = $(this);
                    var name = $input.attr('name');
                    var id = $input.attr('id');

                    if (name) {
                        var newName = name.replace(/Tenants\[\d+\]/, 'Tenants[' + idx + ']');
                        $input.attr('name', newName);
                    }

                    if (id) {
                        var newId = id.replace(/Tenants_\d+__/, 'Tenants_' + idx + '__');
                        $input.attr('id', newId);
                    }
                });

                // Update file input and related elements
                $card.find('input[type="file"]').attr({
                    'id': 'inputFile' + idx,
                    'data-tenant-index': idx
                });

                $card.find('label[for^="inputFile"]').attr('for', 'inputFile' + idx);

                $card.find('[id^="fileInfo"], [id^="fileCount"], [id^="fileList"], [id^="btn"], [id^="loading"], [id^="results"]').each(function() {
                    var oldId = $(this).attr('id');
                    if (oldId) {
                        var prefix = oldId.replace(/\d+$/, '');
                        $(this).attr('id', prefix + idx);
                    }
                });

                // Update clear button onclick
                $card.find('button[onclick^="clearTenantFiles"]').attr('onclick', 'clearTenantFiles(' + idx + ')');
            });
        }

        // Enhanced remove tenant function
        $(document).on('click', '.remove-tenant', function() {
            if ($('#tenantList .tenant-card').length <= 1) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Không thể xóa',
                    text: 'Hợp đồng phải có ít nhất một người thuê.',
                    confirmButtonText: 'Đã hiểu'
                });
                return;
            }

            $(this).closest('.tenant-card').remove();
            updateTenantNumbers();
        });

        // API Read CCCD function (same as Create)
        const elements = document.getElementsByName('uploadButton');
        for (const element of elements) {
            AddEventReadCCCD(element);
        }

        function AddEventReadCCCD(element) {
            element.addEventListener('click', function() {
                var index = this.id.replace("btn", "");
                var fileInput = document.getElementById("inputFile" + index);
                var files = fileInput.files;

                if (!files || files.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Chưa chọn file',
                        text: 'Vui lòng chọn ít nhất một file giấy tờ trước khi quét.',
                        confirmButtonText: 'Đã hiểu',
                        confirmButtonColor: '#667eea'
                    });
                    return;
                }

                var formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append("inputFiles", files[i]);
                }

                var xhr = new XMLHttpRequest();
                xhr.open("POST", "@Url.Action("ReadCCCD", "CardReader")", true);

                xhr.onload = function() {
                    document.getElementById("loading" + index).style.display = "none";
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            var response = JSON.parse(xhr.responseText);
                            if (response.success) {
                                if (response.data) {
                                    displayResults(response.data, index);
                                }
                            } else {
                                document.getElementById("results" + index).innerHTML =
                                    `<div class='scan-result error'>
                                        <i class='fas fa-exclamation-triangle'></i> ${response.message}
                                    </div>`;
                            }
                        } catch (e) {
                            document.getElementById("results" + index).innerHTML =
                                `<div class='scan-result error'>
                                    <i class='fas fa-exclamation-triangle'></i> Lỗi xử lý: ${e.message}
                                </div>`;
                        }
                    }
                };

                xhr.onerror = function() {
                    document.getElementById("loading" + index).style.display = "none";
                    document.getElementById("results" + index).innerHTML =
                        `<div class='scan-result error'>
                            <i class='fas fa-exclamation-triangle'></i> Lỗi kết nối mạng
                        </div>`;
                };

                document.getElementById("loading" + index).style.display = "block";
                document.getElementById("results" + index).innerHTML = "";
                xhr.send(formData);
            });
        }

        function displayResults(apiResponse, pos) {
            var resultsDiv = $("#results" + pos);
            resultsDiv.empty();

            if (apiResponse.errorCode === 0 && apiResponse.data && apiResponse.data.length > 0) {
                var message = apiResponse.errorMessage || "";
                var scanClass = "success";

                if (message.includes("Chưa có mặt trước") || message.includes("Chưa có mặt sau")) {
                    scanClass = "partial";
                }

                resultsDiv.html(`
                    <div class='scan-result ${scanClass}'>
                        <i class='fas fa-check-circle'></i> Đã quét thông tin từ giấy tờ!
                        ${message ? `<br><small>${message}</small>` : ''}
                    </div>
                `);

                // Fill information
                $.each(apiResponse.data, function(i, cardData) {
                    if (cardData.id) {
                        $(`#Tenants_${pos}__IdentityCard, input[name="Tenants[${pos}].IdentityCard"]`).val(cardData.id);
                    }
                    if (cardData.name) {
                        $(`#Tenants_${pos}__FullName, input[name="Tenants[${pos}].FullName"]`).val(cardData.name);
                    }
                    if (cardData.dob) {
                        let dob = cardData.dob.trim();
                        if (/^\d{4}-\d{2}-\d{2}$/.test(dob)) {
                            let parts = dob.split("-");
                            dob = parts[2] + "/" + parts[1] + "/" + parts[0];
                        }
                        var dobInput = $(`#Tenants_${pos}__BirthDate, input[name="Tenants[${pos}].BirthDate"]`);
                        dobInput.datepicker('update', dob);
                        dobInput.val(dob);
                    }
                    if (cardData.sex) {
                        var genderValue = "Nam";
                        if (cardData.sex === "NỮ") {
                            genderValue = "Nữ";
                        } else if (cardData.sex === "NAM") {
                            genderValue = "Nam";
                        }
                        $(`#Tenants_${pos}__Gender, select[name="Tenants[${pos}].Gender"]`).val(genderValue);
                    }
                    if (cardData.address && cardData.address !== "N/A") {
                        $(`#Tenants_${pos}__PermanentAddress, input[name="Tenants[${pos}].PermanentAddress"]`).val(cardData.address);
                    }
                    if (cardData.ethnicity) {
                        $(`#Tenants_${pos}__Ethnicity, input[name="Tenants[${pos}].Ethnicity"]`).val(cardData.ethnicity);
                    }
                });
            } else {
                resultsDiv.html(`
                    <div class='scan-result error'>
                        <i class='fas fa-info-circle'></i> Không tìm thấy dữ liệu
                    </div>
                `);
            }
        }

        // Initialize when page loads
        $(document).ready(function() {
            // Datepicker
            $('.datepicker').datepicker({
                format: "dd/mm/yyyy",
                autoclose: true,
                todayHighlight: true
            });

            // Set tenant index for existing file inputs
            $('input[type="file"][name="TenantPhotos"]').each(function(index) {
                $(this).attr('data-tenant-index', index);
            });

            // Animation for cards
            $('.edit-card').each(function(i) {
                $(this).css('opacity', '0');
                $(this).css('transform', 'translateY(20px)');
                setTimeout(() => {
                    $(this).css('transition', 'all 0.5s ease');
                    $(this).css('opacity', '1');
                    $(this).css('transform', 'translateY(0)');
                }, i * 100);
            });
        });
        $(document).ready(function () {

            // Override file input change handler
            $(document).on('change', 'input[type="file"][name="TenantPhotos"]', function () {
                var tenantIndex = $(this).attr('data-tenant-index');
                var files = this.files;

                // Đảm bảo tenant index được lưu với mỗi file
                $(this).data('tenant-index', tenantIndex);

                // Cập nhật hiển thị
                updateFileDisplay(tenantIndex, files);
            });

            // Cải tiến form submit để include tenant mapping
            $('form').on('submit', function (e) {
                // Tạo FormData mới với mapping chính xác
                var formData = new FormData(this);

                // Xóa tất cả TenantPhotos hiện tại
                formData.delete('TenantPhotos');

                // Thu thập và re-append files với thông tin tenant
                $('input[type="file"][name="TenantPhotos"]').each(function (index) {
                    var tenantIndex = $(this).attr('data-tenant-index');
                    var files = this.files;

                    for (let i = 0; i < files.length; i++) {
                        // Rename file để include tenant index
                        var file = files[i];
                        var newFileName = `tenant_${tenantIndex}_${file.name}`;

                        // Tạo new File object với tên mới
                        var renamedFile = new File([file], newFileName, {
                            type: file.type,
                            lastModified: file.lastModified
                        });

                        formData.append('TenantPhotos', renamedFile);
                    }
                });

                // Continue with normal form submission
                // (Remove e.preventDefault() để form submit bình thường)
            });

            // Helper function để update file display
            function updateFileDisplay(tenantIndex, files) {
                var fileInfo = $("#fileInfo" + tenantIndex);
                var fileList = $("#fileList" + tenantIndex);

                fileList.empty();

                if (files && files.length > 0) {
                    fileInfo.show();
                    $("#fileCount" + tenantIndex).text(files.length);

                    for (let i = 0; i < files.length; i++) {
                        var fileSize = (files[i].size / 1024).toFixed(1) + " KB";
                        fileList.append(`
                    <div class="file-item" data-file-index="${i}">
                        <span>
                            <i class="fas fa-file-image text-primary"></i>
                            ${files[i].name} (${fileSize})
                            <small class="text-success">- Tenant #${parseInt(tenantIndex) + 1}</small>
                        </span>
                        <button type="button" onclick="removeFileImproved(${tenantIndex}, ${i})"
                                class="btn-remove-file" title="Xóa file này">×</button>
                    </div>
                `);
                    }
                } else {
                    fileInfo.hide();
                    $("#fileCount" + tenantIndex).text("0");
                }
            }
        });

        // Cải tiến hàm remove file
        function removeFileImproved(inputIndex, fileIndex) {
            var input = document.getElementById("inputFile" + inputIndex);

            if (!input.files || fileIndex >= input.files.length) {
                return;
            }

            try {
                var dt = new DataTransfer();

                // Copy tất cả files ngoại trừ file cần xóa
                for (let i = 0; i < input.files.length; i++) {
                    if (i !== fileIndex) {
                        dt.items.add(input.files[i]);
                    }
                }

                // Cập nhật input
                input.files = dt.files;

                // Trigger change event để update display
                $(input).trigger('change');

            } catch (e) {
                // Fallback cho browsers cũ
                console.error('DataTransfer not supported:', e);

                // Alternative: Clone input và reset
                var newInput = $(input).clone(true);
                $(input).replaceWith(newInput);

                Swal.fire({
                    icon: 'info',
                    title: 'Không thể xóa file riêng lẻ',
                    text: 'Vui lòng chọn lại tất cả file ngoại trừ file muốn xóa.',
                    confirmButtonText: 'Đã hiểu'
                });
            }
        }

        // Debug function để kiểm tra file mapping
        function debugFileMapping() {
            console.log('=== File Mapping Debug ===');
            $('input[type="file"][name="TenantPhotos"]').each(function (index) {
                var tenantIndex = $(this).attr('data-tenant-index');
                var files = this.files;
                console.log(`Tenant ${tenantIndex}: ${files.length} files`);
                for (let i = 0; i < files.length; i++) {
                    console.log(`  - ${files[i].name} (${(files[i].size / 1024).toFixed(1)}KB)`);
                }
            });
        }
    </script>
}