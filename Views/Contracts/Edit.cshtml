@model NhaTroAnCu.Models.ContractEditViewModel
@using NhaTroAnCu.Models
@{
    ViewBag.Title = "Chỉnh sửa Hợp Đồng #" + Model.Id;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/CSS/contract-action.css" rel="stylesheet" />

<div class="contract-form-container">
    <div class="form-header">
        <h2><i class="fas fa-edit"></i> Chỉnh Sửa Hợp Đồng #@Model.Id</h2>
        <p>Cập nhật thông tin hợp đồng thuê nhà</p>
    </div>

    @using (Html.BeginForm("Edit", "Contracts", FormMethod.Post, new { @class = "contract-form", enctype = "multipart/form-data" }))
    {
        @Html.AntiForgeryToken()
        @Html.HiddenFor(m => m.Id)
        @Html.HiddenFor(m => m.ContractType)
        @Html.HiddenFor(m => m.CompanyId)
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

        <!-- Thông tin loại hợp đồng -->
        <div class="form-section">
            <div class="section-title">
                <i class="fas fa-info-circle"></i> Loại Hợp Đồng
            </div>
            <div class="alert alert-info">
                <i class="fas fa-@(Model.ContractType == "Company" ? "building" : "user")"></i>
                <strong>@(Model.ContractType == "Company" ? "Hợp đồng Công ty" : "Hợp đồng Cá nhân")</strong>
                @if (Model.ContractType == "Company" && !string.IsNullOrEmpty(Model.CompanyName))
                {
                    <span> - @Model.CompanyName</span>
                }
            </div>
        </div>

        <!-- Thông tin chung hợp đồng -->
        <div class="form-section">
            <div class="section-title">
                <i class="fas fa-file-contract"></i> Thông Tin Hợp Đồng
            </div>

            <div class="form-row">
                <div class="form-group">
                    @Html.LabelFor(m => m.StartDate)
                    @Html.TextBoxFor(m => m.StartDate, new { @class = "form-control datetime", @Value = Model.StartDate.ToString("dd/MM/yyyy") })
                    @Html.ValidationMessageFor(m => m.StartDate, "", new { @class = "text-danger" })
                </div>

                <div class="form-group">
                    @Html.LabelFor(m => m.EndDate)
                    @Html.TextBoxFor(m => m.EndDate, new { @class = "form-control datetime", @Value = Model.EndDate.ToString("dd/MM/yyyy") })
                    @Html.ValidationMessageFor(m => m.EndDate, "", new { @class = "text-danger" })
                </div>

                <div class="form-group">
                    @Html.LabelFor(m => m.MoveInDate)
                    @Html.TextBoxFor(m => m.MoveInDate, new { @class = "form-control datetime", @Value = Model.MoveInDate.ToString("dd/MM/yyyy") })
                    @Html.ValidationMessageFor(m => m.MoveInDate, "", new { @class = "text-danger" })
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    @Html.LabelFor(m => m.ElectricityPrice)
                    @Html.TextBoxFor(m => m.ElectricityPrice, new { @class = "form-control money" })
                    @Html.ValidationMessageFor(m => m.ElectricityPrice, "", new { @class = "text-danger" })
                </div>

                <div class="form-group">
                    @Html.LabelFor(m => m.WaterPrice)
                    @Html.TextBoxFor(m => m.WaterPrice, new { @class = "form-control money" })
                    @Html.ValidationMessageFor(m => m.WaterPrice, "", new { @class = "text-danger" })
                </div>

                <div class="form-group">
                    @Html.LabelFor(m => m.Status)
                    @Html.DropDownListFor(m => m.Status, new SelectList(new[] {
                        new { Value = "Active", Text = "Đang hoạt động" },
                        new { Value = "Inactive", Text = "Không hoạt động" },
                        new { Value = "Ended", Text = "Đã kết thúc" }
                    }, "Value", "Text", Model.Status), new { @class = "form-control" })
                    @Html.ValidationMessageFor(m => m.Status, "", new { @class = "text-danger" })
                </div>
            </div>

            <div class="form-group">
                @Html.LabelFor(m => m.Note)
                @Html.TextAreaFor(m => m.Note, new { @class = "form-control", rows = 3 })
                @Html.ValidationMessageFor(m => m.Note, "", new { @class = "text-danger" })
            </div>
        </div>

        <!-- Thông tin phòng và giá thuê -->
        if (Model.ContractType == "Individual")
        {
            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-door-open"></i> Thông Tin Phòng
                </div>

                <div class="form-row">
                    <div class="form-group">
                        @Html.LabelFor(m => m.RoomId)
                        @Html.DropDownListFor(m => m.RoomId, (IEnumerable<SelectListItem>)ViewBag.AvailableRooms,
                            "-- Chọn phòng --", new { @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.RoomId, "", new { @class = "text-danger" })
                    </div>

                    <div class="form-group">
                        @Html.LabelFor(m => m.PriceAgreed)
                        @Html.TextBoxFor(m => m.PriceAgreed, new { @class = "form-control money" })
                        @Html.ValidationMessageFor(m => m.PriceAgreed, "", new { @class = "text-danger" })
                    </div>
                </div>
            </div>

            <!-- Thông tin người thuê -->
            @Html.Partial("_TenantManagement", new TenantManagementViewModel() { ContractId = Model.Id, RoomId = Model.RoomId.Value, Tenants = Model.Tenants })
        }
        else if (Model.ContractType == "Company")
        {
            <!-- Thông tin phòng cho công ty -->
            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-building"></i> Quản Lý Phòng Của Công Ty
                    <button type="button" class="btn btn-sm btn-success float-right" onclick="openAddRoomModal()">
                        <i class="fas fa-plus"></i> Thêm phòng
                    </button>
                </div>

                <div id="companyRoomsContainer">
                    @if (Model.SelectedRooms != null && Model.SelectedRooms.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover" id="roomsTable">
                                <thead>
                                    <tr>
                                        <th width="5%">
                                            <input type="checkbox" id="selectAllRooms" />
                                        </th>
                                        <th width="20%">Phòng</th>
                                        <th width="15%">Giá mặc định</th>
                                        <th width="20%">Giá thỏa thuận</th>
                                        <th width="15%">Số người thuê</th>
                                        <th width="15%">Trạng thái</th>
                                        <th width="10%">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (int i = 0; i < Model.SelectedRooms.Count; i++)
                                    {
                                        var room = Model.SelectedRooms[i];
                                        var tenantCount = ViewBag.RoomTenantCounts != null &&
                                                        ViewBag.RoomTenantCounts.ContainsKey(room.RoomId)
                                                        ? ViewBag.RoomTenantCounts[room.RoomId] : 0;
                                        <tr class="room-row" data-room-id="@room.RoomId" data-index="@i">
                                            <td>
                                                <input type="checkbox" class="room-checkbox" value="@room.RoomId" />
                                                @Html.HiddenFor(m => m.SelectedRooms[i].RoomId)
                                                @Html.HiddenFor(m => m.SelectedRooms[i].RoomName)
                                                @Html.HiddenFor(m => m.SelectedRooms[i].DefaultPrice)
                                            </td>
                                            <td>
                                                <strong>@room.RoomName</strong>
                                            </td>
                                            <td>
                                                <span class="text-muted">@room.DefaultPrice.ToString("N0") VNĐ</span>
                                            </td>
                                            <td>
                                                @Html.TextBoxFor(m => m.SelectedRooms[i].AgreedPrice,
                                                    new { @class = "form-control money room-price", data_room_id = room.RoomId })
                                            </td>
                                            <td>
                                                <span class="badge badge-info tenant-count-badge">
                                                    <i class="fas fa-users"></i> @tenantCount người
                                                </span>
                                                @if (tenantCount < 4)
                                                {
                                                    <button type="button" class="btn btn-sm btn-link"
                                                            onclick="addTenantToRoom(@room.RoomId, '@room.RoomName')">
                                                        <i class="fas fa-user-plus"></i>
                                                    </button>
                                                }
                                            </td>
                                            <td>
                                                @if (tenantCount > 0)
                                                {
                                                    <span class="badge badge-success">Đang sử dụng</span>
                                                }
                                                else
                                                {
                                                    <span class="badge badge-warning">Trống</span>
                                                }
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button type="button" class="btn btn-danger"
                                                            onclick="removeRoom(@room.RoomId, '@room.RoomName', @tenantCount)"
                                                            title="Xóa phòng">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="3">Tổng cộng:</th>
                                        <th>
                                            <span id="totalRent">0</span> VNĐ
                                        </th>
                                        <th colspan="3">
                                            <span id="totalRooms">@Model.SelectedRooms.Count</span> phòng
                                        </th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <!-- Hidden inputs để track rooms khi submit -->
                        <div id="hiddenRoomInputs" style="display:none;">
                            <!-- Sẽ được generate bởi JavaScript khi thêm/xóa phòng -->
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            Hợp đồng chưa có phòng nào.
                            <a href="javascript:void(0)" onclick="openAddRoomModal()">Thêm phòng ngay</a>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Modal thêm phòng -->
        <div class="modal fade" id="addRoomModal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-plus-circle"></i> Thêm Phòng Vào Hợp Đồng
                        </h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Tìm kiếm phòng:</label>
                            <input type="text" id="searchRoom" class="form-control"
                                   placeholder="Nhập tên phòng để tìm kiếm...">
                        </div>

                        <div class="available-rooms-list" style="max-height: 400px; overflow-y: auto;">
                            <!-- Sẽ được load bằng AJAX -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                        <button type="button" class="btn btn-primary" onclick="confirmAddRooms()">
                            <i class="fas fa-plus"></i> Thêm phòng đã chọn
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- File scan hợp đồng -->
        <div class="form-section">
            <div class="section-title">
                <i class="fas fa-file-pdf"></i> File Scan Hợp Đồng
            </div>

            @if (!string.IsNullOrEmpty(Model.ContractScanFilePath))
            {
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    File hiện tại: <a href="@Model.ContractScanFilePath" target="_blank">Xem file</a>
                </div>
            }

            <div class="form-group">
                <label>Tải lên file mới (PDF, JPG, PNG - Tối đa 5MB)</label>
                <input type="file" name="ContractScanFile" class="form-control-file" accept=".pdf,.jpg,.jpeg,.png" />
                <small class="form-text text-muted">Bỏ trống nếu không muốn thay đổi file hiện tại</small>
            </div>
        </div>

        <!-- Buttons -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Lưu thay đổi
            </button>
            <a href="@Url.Action("Details", new { id = Model.Id })" class="btn btn-secondary">
                <i class="fas fa-times"></i> Hủy
            </a>
        </div>
    }
</div>

<div class="modal fade" id="manageTenantModal" tabindex="-1" role="dialog" aria-labelledby="manageTenantModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="manageTenantModalLabel">
                    <i class="fas fa-users"></i> Quản Lý Khách Thuê -
                    <span id="modalRoomName">Phòng</span>
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <!-- Hidden fields -->
                <input type="hidden" id="modalRoomId" />
                <input type="hidden" id="modalRoomIndex" />

                <!-- Room info bar -->
                <div class="room-info-bar bg-light p-3 rounded mb-3">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Phòng:</strong>
                            <span id="modalRoomNameInfo"></span>
                        </div>
                        <div class="col-md-3">
                            <strong>Giá thuê:</strong>
                            <span id="modalRoomPrice" class="text-primary font-weight-bold"></span>
                        </div>
                        <div class="col-md-3">
                            <strong>Số người hiện tại:</strong>
                            <span class="badge badge-info" id="modalTenantCount">0/4</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Trạng thái:</strong>
                            <span class="badge badge-success" id="modalRoomStatus">Còn chỗ</span>
                        </div>
                    </div>
                </div>

                <!-- Tabs navigation -->
                <ul class="nav nav-tabs" id="tenantTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="current-tab" data-toggle="tab" href="#currentTenants" role="tab">
                            <i class="fas fa-users"></i> Khách thuê hiện tại
                            <span class="badge badge-primary ml-1" id="currentTenantBadge">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="add-tab" data-toggle="tab" href="#addNewTenant" role="tab">
                            <i class="fas fa-user-plus"></i> Thêm khách thuê mới
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="transfer-tab" data-toggle="tab" href="#transferTenant" role="tab">
                            <i class="fas fa-exchange-alt"></i> Chuyển từ phòng khác
                        </a>
                    </li>
                </ul>

                <!-- Tab content -->
                <div class="tab-content mt-3" id="tenantTabContent">
                    <!-- Tab 1: Current tenants -->
                    <div class="tab-pane fade show active" id="currentTenants" role="tabpanel">
                        <div id="currentTenantsList">
                            <!-- Dynamic tenant cards will be inserted here -->
                        </div>

                        <div class="alert alert-info mt-3" id="noTenantsAlert" style="display:none;">
                            <i class="fas fa-info-circle"></i>
                            Phòng này chưa có khách thuê nào.
                            <a href="#" onclick="$('a[href=\'#addNewTenant\']').tab('show'); return false;">
                                Thêm khách thuê ngay
                            </a>
                        </div>
                    </div>

                    <!-- Tab 2: Add new tenant -->
                    <div class="tab-pane fade" id="addNewTenant" role="tabpanel">
                        <form id="addTenantForm" novalidate>
                            <!-- Quick actions -->
                            <div class="quick-actions mb-3 p-3 bg-light rounded">
                                <button type="button" class="btn btn-primary mr-2" onclick="CompanyTenantManager.quickAddTenant()">
                                    <i class="fas fa-bolt"></i> Thêm nhanh
                                </button>
                                <label class="btn btn-info mb-0">
                                    <i class="fas fa-qrcode"></i> Quét CCCD
                                    <input type="file" id="cccdScanFile" accept="image/*" style="display:none;">
                                </label>
                            </div>

                            <h6 id="addTenantFormTitle">Thêm khách thuê mới</h6>

                            <!-- Form fields -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Họ và tên <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="newTenantName" required
                                               placeholder="Nhập họ và tên">
                                        <div class="invalid-feedback">Vui lòng nhập họ tên</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Số CCCD/CMND <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="newTenantIdentity" required
                                               placeholder="Nhập số CCCD/CMND" maxlength="12">
                                        <div class="invalid-feedback">Vui lòng nhập số CCCD/CMND</div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Số điện thoại</label>
                                        <input type="tel" class="form-control" id="newTenantPhone"
                                               placeholder="Nhập số điện thoại">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Ngày sinh</label>
                                        <input type="text" class="form-control datetime" id="newTenantBirthDate"
                                               placeholder="dd/mm/yyyy">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Giới tính</label>
                                        <select class="form-control" id="newTenantGender">
                                            <option value="">-- Chọn --</option>
                                            <option value="Nam">Nam</option>
                                            <option value="Nữ">Nữ</option>
                                            <option value="Khác">Khác</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Dân tộc</label>
                                        <input type="text" class="form-control" id="newTenantEthnicity"
                                               placeholder="Ví dụ: Kinh">
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label>Địa chỉ thường trú</label>
                                        <input type="text" class="form-control" id="newTenantAddress"
                                               placeholder="Nhập địa chỉ thường trú">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Biển số xe</label>
                                        <input type="text" class="form-control" id="newTenantVehicle"
                                               placeholder="Ví dụ: 59A-12345">
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label>Upload ảnh chân dung</label>
                                        <div class="custom-file">
                                            <input type="file" class="custom-file-input" id="newTenantPhoto" accept="image/*">
                                            <label class="custom-file-label" for="newTenantPhoto">Chọn ảnh...</label>
                                        </div>
                                        <small class="text-muted">Ảnh sẽ được lưu làm ảnh đại diện của khách thuê</small>
                                        <div class="mt-2">
                                            <img id="newTenantPhotoPreview" src="" alt="Preview"
                                                 style="max-width: 150px; display: none;" class="img-thumbnail">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <button type="submit" class="btn btn-primary" id="addTenantSubmitBtn">
                                    <i class="fas fa-plus"></i> Thêm khách thuê
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="CompanyTenantManager.resetModalForm()">
                                    <i class="fas fa-undo"></i> Làm mới
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Tab 3: Transfer tenant -->
                    <div class="tab-pane fade" id="transferTenant" role="tabpanel">
                        <div class="form-group">
                            <label>Chọn phòng nguồn:</label>
                            <select class="form-control" id="sourceRoomSelect">
                                <option value="">-- Chọn phòng có khách thuê --</option>
                            </select>
                        </div>

                        <div id="sourceRoomTenants" style="display:none;">
                            <div class="form-group">
                                <label>Tìm kiếm khách thuê:</label>
                                <input type="text" class="form-control" id="searchTransferTenant"
                                       placeholder="Nhập tên hoặc CCCD để tìm...">
                            </div>

                            <h6 class="mt-3">
                                Chọn khách thuê để chuyển:
                                <div class="float-right">
                                    <label class="mb-0">
                                        <input type="checkbox" id="selectAllTransfer"> Chọn tất cả
                                    </label>
                                </div>
                            </h6>

                            <div id="transferTenantsList" style="max-height: 300px; overflow-y: auto;">
                                <!-- Dynamic content -->
                            </div>

                            <button type="button" class="btn btn-warning mt-3" onclick="CompanyTenantManager.confirmTransfer()">
                                <i class="fas fa-exchange-alt"></i> Xác nhận chuyển
                            </button>
                        </div>

                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-info-circle"></i>
                            <strong>Lưu ý:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Khách thuê sẽ được chuyển sang phòng này</li>
                                <li>Thông tin khách thuê sẽ được giữ nguyên</li>
                                <li>Khách thuê sẽ bị xóa khỏi phòng cũ</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Đóng
                </button>
                <button type="button" class="btn btn-success" onclick="CompanyTenantManager.saveRoomTenants()">
                    <i class="fas fa-save"></i> Lưu thay đổi
                </button>
            </div>
        </div>
    </div>
</div>
<style>
/* Modal styles */
#manageTenantModal .modal-dialog {
    max-width: 1200px;
}

.room-info-bar {
    border-left: 4px solid #007bff;
    background: linear-gradient(to right, #f8f9fa, #ffffff);
}

.tenant-card-modal {
    animation: slideIn 0.3s ease;
}

@*@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}*@

.tenant-card-modal .card {
    transition: all 0.3s;
    border-left: 3px solid #28a745;
}

.tenant-card-modal .card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.tenant-avatar {
    border: 3px solid #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.quick-actions {
    border: 2px dashed #dee2e6;
}

.transfer-tenant-item {
    cursor: pointer;
    transition: background 0.2s;
}

.transfer-tenant-item:hover {
    background: #f1f3f5;
}

.nav-tabs .nav-link {
    font-weight: 500;
    color: #495057;
}

.nav-tabs .nav-link.active {
    color: #007bff;
    border-color: #dee2e6 #dee2e6 #fff;
    font-weight: 600;
}

.nav-tabs .nav-link .badge {
    font-size: 0.75rem;
}

/* Custom file input */
.custom-file-label::after {
    content: "Chọn file";
}

/* Responsive */
@*@media (max-width: 768px) {
    #manageTenantModal .modal-dialog {
        max-width: 100%;
        margin: 10px;
    }

    .room-info-bar .row > div {
        margin-bottom: 10px;
    }
}*@
</style>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/js/tenant-management.js"></script>    
    <script>        

        // Biến tracking submit
        var isFormSubmitting = false;

        $(document).ready(function() {
            // Khởi tạo TenantManager
            TenantManager.init();

            // XỬ LÝ SUBMIT FORM - SỬA LẠI HOÀN TOÀN
            $('form.contract-form').off('submit').on('submit', function(e) {
                // Nếu đang submit rồi thì cho qua
                if (isFormSubmitting) {
                    return true;
                }

                // Chặn submit tạm thời để validate
                e.preventDefault();
                e.stopPropagation();

                var $form = $(this);
                var contractType = '@Model.ContractType';
                var isValid = true;
                var errorMessage = '';

                // 1. XỬ LÝ AUTONUMERIC - Lấy raw values
                $('.money').each(function() {
                    var $input = $(this);
                    try {
                        // Kiểm tra xem đã khởi tạo AutoNumeric chưa
                        var anElement = AutoNumeric.getAutoNumericElement($input[0]);
                        if (anElement) {
                            var rawValue = anElement.getNumber();
                            // Set giá trị raw vào input
                            anElement.set(rawValue);
                            // Tạm thời remove AutoNumeric để submit raw value
                            anElement.remove();
                            $input.val(rawValue);
                            console.log('Raw value for ' + $input.attr('name') + ': ' + rawValue);
                        }
                    } catch(e) {
                        // Nếu chưa khởi tạo AutoNumeric thì bỏ qua
                        console.log('AutoNumeric not initialized for: ', $input.attr('name'));
                    }
                });

                // 2. VALIDATE HỢP ĐỒNG CÁ NHÂN
                if (contractType === 'Individual') {
                    // Check phòng
                    if (!$('#RoomId').val()) {
                        isValid = false;
                        errorMessage = 'Vui lòng chọn phòng cho hợp đồng!';
                    }
                    // Check giá thuê
                    else if (!$('#PriceAgreed').val() || parseFloat($('#PriceAgreed').val()) <= 0) {
                        isValid = false;
                        errorMessage = 'Vui lòng nhập giá thuê thỏa thuận!';
                    }
                    // Check tenant
                    else {
                        var hasValidTenant = false;
                        $('.tenant-card').each(function() {
                            var fullName = $(this).find('.tenant-fullname').val();
                            var identity = $(this).find('.tenant-identity').val();
                            if (fullName && identity) {
                                hasValidTenant = true;
                                return false;
                            }
                        });

                        if (!hasValidTenant) {
                            isValid = false;
                            errorMessage = 'Vui lòng nhập ít nhất thông tin 1 người thuê (Họ tên và CCCD)!';
                        }
                    }
                }

                // 3. VALIDATE HỢP ĐỒNG CÔNG TY
                else if (contractType === 'Company') {
                    // Check có phòng không
                    if ($('.room-row').length === 0) {
                        isValid = false;
                        errorMessage = 'Vui lòng chọn ít nhất 1 phòng cho hợp đồng công ty!';
                    }
                    // Check giá các phòng
                    else {
                        $('.room-row').each(function() {
                            var priceInput = $(this).find('input[name*="AgreedPrice"]');
                            var price = parseFloat(priceInput.val()) || 0;
                            if (price <= 0) {
                                isValid = false;
                                errorMessage = 'Vui lòng nhập giá thuê cho tất cả các phòng!';
                                return false;
                            }
                        });
                    }

                    // Reindex rooms trước khi submit
                    if (isValid) {
                        reindexCompanyRooms();
                    }
                }

                // 4. VALIDATE DATES
                if (isValid) {
                    var startDateStr = $('#StartDate').val();
                    var endDateStr = $('#EndDate').val();

                    if (startDateStr && endDateStr) {
                        // Convert dd/MM/yyyy to Date
                        var startParts = startDateStr.split('/');
                        var endParts = endDateStr.split('/');

                        var startDate = new Date(startParts[2], startParts[1] - 1, startParts[0]);
                        var endDate = new Date(endParts[2], endParts[1] - 1, endParts[0]);

                        if (endDate <= startDate) {
                            isValid = false;
                            errorMessage = 'Ngày kết thúc phải sau ngày bắt đầu!';
                        }
                    }
                }

                // 5. XỬ LÝ KẾT QUẢ VALIDATE
                if (!isValid) {
                    // Hiển thị lỗi
                    Swal.fire({
                        icon: 'warning',
                        title: 'Thông tin không hợp lệ',
                        text: errorMessage,
                        confirmButtonColor: '#ffc107'
                    });

                    // Re-init AutoNumeric cho các field money
                    reinitAutoNumeric();

                    return false;
                }

                // 6. SUBMIT FORM THỰC SỰ
                isFormSubmitting = true;

                // Disable nút submit
                $form.find('button[type="submit"]').prop('disabled', true)
                    .html('<i class="fas fa-spinner fa-spin"></i> Đang lưu...');

                // Submit form using native JavaScript
                console.log('Submitting form to server...');

                // QUAN TRỌNG: Dùng setTimeout để đảm bảo tất cả xử lý xong
                setTimeout(function() {
                    // Submit bằng native JS, không qua jQuery
                    $form[0].submit();
                }, 100);
            });

            // Các functions hỗ trợ khác giữ nguyên...

            // Function reinit AutoNumeric sau khi validate fail
            function reinitAutoNumeric() {
                $('.money').each(function() {
                    var $input = $(this);
                    var value = $input.val();

                    try {
                        // Nếu chưa có AutoNumeric thì khởi tạo
                        var anElement = AutoNumeric.getAutoNumericElement($input[0]);
                        if (!anElement) {
                            new AutoNumeric($input[0], {
                                digitGroupSeparator: '.',
                                decimalCharacter: ',',
                                decimalPlaces: 0,
                                suffixText: ' đ',
                                minimumValue: '0'
                            });
                        }
                    } catch(e) {
                        // Khởi tạo mới
                        new AutoNumeric($input[0], {
                            digitGroupSeparator: '.',
                            decimalCharacter: ',',
                            decimalPlaces: 0,
                            suffixText: ' đ',
                            minimumValue: '0'
                        });
                    }

                    // Set lại value nếu có
                    if (value) {
                        AutoNumeric.getAutoNumericElement($input[0]).set(value);
                    }
                });
            }

            // Function reindex rooms cho company contract
            function reindexCompanyRooms() {
                $('.room-row').each(function(index) {
                    $(this).attr('data-index', index);
                    $(this).find('input[name*="SelectedRooms"]').each(function() {
                        var name = $(this).attr('name');
                        if (name) {
                            var newName = name.replace(/\[\d+\]/, '[' + index + ']');
                            $(this).attr('name', newName);
                        }
                    });
                });
            }

            // XỬ LÝ THAY ĐỔI PHÒNG (Individual Contract)
            $('#RoomId').on('change', function() {
                var selectedOption = $(this).find('option:selected');
                var priceText = selectedOption.text();

                var priceMatch = priceText.match(/[\d.]+(?=\s*VNĐ)/);
                if (priceMatch) {
                    var price = priceMatch[0].replace(/\./g, '');

                    // Set value cho AutoNumeric
                    var priceInput = $('#PriceAgreed')[0];
                    var anElement = AutoNumeric.getAutoNumericElement(priceInput);
                    if (anElement) {
                        anElement.set(price);
                    } else {
                        $('#PriceAgreed').val(price);
                    }
                }
            });

            // COMPANY CONTRACT FUNCTIONS
            if ('@Model.ContractType' === 'Company') {
                calculateTotal();

                $('#selectAllRooms').on('change', function() {
                    $('.room-checkbox').prop('checked', $(this).prop('checked'));
                });

                $(document).on('input', '.room-price', function() {
                    calculateTotal();
                });
            }
        });

        // === GLOBAL FUNCTIONS (được gọi từ onclick) ===

        // Tenant management
        function addTenant() {
            TenantManager.addTenant();
        }

        function removeTenant(index) {
            TenantManager.removeTenant(index);
        }

        function scanCCCD(index) {
            TenantManager.scanCCCD(index);
        }

        // Company rooms management
        var contractId = @Model.Id;
        var roomIndex = @(Model.SelectedRooms?.Count ?? 0);

        function calculateTotal() {
            var total = 0;
            $('.room-price').each(function() {
                try {
                    var anElement = AutoNumeric.getAutoNumericElement(this);
                    if (anElement) {
                        total += anElement.getNumber();
                    } else {
                        var value = $(this).val().replace(/\./g, '').replace(/,/g, '');
                        total += parseFloat(value) || 0;
                    }
                } catch(e) {
                    var value = $(this).val().replace(/\./g, '').replace(/,/g, '');
                    total += parseFloat(value) || 0;
                }
            });
            $('#totalRent').text(total.toLocaleString('vi-VN'));
        }

        function openAddRoomModal() {
            loadAvailableRooms();
            $('#addRoomModal').modal('show');
        }

        function loadAvailableRooms() {
            $('.available-rooms-list').html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Đang tải...</div>');

            $.ajax({
                url: '@Url.Action("GetAvailableRoomsForCompany", "Contracts")',
                type: 'GET',
                data: { contractId: contractId },
                success: function(response) {
                    if (response.success) {
                        var html = '<div class="list-group">';

                        if (!response.rooms || response.rooms.length === 0) {
                            html += '<div class="alert alert-info">Không có phòng trống</div>';
                        } else {
                            var availableRooms = response.rooms.filter(function(room) {
                                return !room.IsCurrentlySelected;
                            });

                            if (availableRooms.length === 0) {
                                html += '<div class="alert alert-info">Tất cả phòng trống đã được thêm vào hợp đồng</div>';
                            } else {
                                availableRooms.forEach(function(room) {
                                    html += `
                                        <div class="list-group-item">
                                            <div class="form-check">
                                                <input class="form-check-input new-room-checkbox"
                                                       type="checkbox"
                                                       value="${room.Id}"
                                                       data-name="${room.Name}"
                                                       data-price="${room.DefaultPrice}"
                                                       id="room_${room.Id}">
                                                <label class="form-check-label" for="room_${room.Id}" style="width: 100%; cursor: pointer;">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <strong>${room.Name}</strong>
                                                            <small class="text-muted ml-2">
                                                                Tầng ${room.Floor || 'N/A'} - ${room.Area || 'N/A'}m²
                                                            </small>
                                                        </div>
                                                        <div>
                                                            <span class="badge badge-primary">
                                                                ${parseInt(room.DefaultPrice).toLocaleString('vi-VN')} VNĐ
                                                            </span>
                                                        </div>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    `;
                                });
                            }
                        }

                        html += '</div>';
                        $('.available-rooms-list').html(html);
                    } else {
                        $('.available-rooms-list').html(
                            '<div class="alert alert-danger">' +
                            '<i class="fas fa-exclamation-triangle"></i> ' +
                            (response.message || 'Không thể tải danh sách phòng') +
                            '</div>'
                        );
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', error);
                    $('.available-rooms-list').html(
                        '<div class="alert alert-danger">' +
                        '<i class="fas fa-exclamation-triangle"></i> Lỗi kết nối: ' + error +
                        '</div>'
                    );
                }
            });
        }

        function confirmAddRooms() {
            var selectedRooms = [];
            $('.new-room-checkbox:checked').each(function() {
                selectedRooms.push({
                    id: $(this).val(),
                    name: $(this).data('name'),
                    price: $(this).data('price')
                });
            });

            if (selectedRooms.length === 0) {
                Swal.fire('Thông báo', 'Vui lòng chọn ít nhất một phòng', 'warning');
                return;
            }

            selectedRooms.forEach(function(room) {
                addRoomToTable(room);
            });

            $('#addRoomModal').modal('hide');
            calculateTotal();

            Swal.fire({
                icon: 'success',
                title: 'Thành công',
                text: `Đã thêm ${selectedRooms.length} phòng vào hợp đồng`,
                timer: 2000,
                showConfirmButton: false
            });
        }

        function addRoomToTable(room) {
            var html = `
                <tr class="room-row new-room" data-room-id="${room.id}" data-index="${roomIndex}">
                    <td>
                        <input type="checkbox" class="room-checkbox" value="${room.id}" />
                        <input type="hidden" name="SelectedRooms[${roomIndex}].RoomId" value="${room.id}" />
                        <input type="hidden" name="SelectedRooms[${roomIndex}].RoomName" value="${room.name}" />
                        <input type="hidden" name="SelectedRooms[${roomIndex}].DefaultPrice" value="${room.price}" />
                    </td>
                    <td><strong>${room.name}</strong></td>
                    <td><span class="text-muted">${parseInt(room.price).toLocaleString('vi-VN')} VNĐ</span></td>
                    <td>
                        <input type="text" name="SelectedRooms[${roomIndex}].AgreedPrice"
                               class="form-control money room-price new-money"
                               value="${room.price}"
                               data-room-id="${room.id}" />
                    </td>
                    <td>
                        <span class="badge badge-info tenant-count-badge">
                            <i class="fas fa-users"></i> 0 người
                        </span>
                        <button type="button" class="btn btn-sm btn-link"
                                onclick="addTenantToRoom(${room.id}, '${room.name}')">
                            <i class="fas fa-user-plus"></i>
                        </button>
                    </td>
                    <td><span class="badge badge-warning">Trống</span></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-danger"
                                    onclick="removeRoom(${room.id}, '${room.name}', 0)"
                                    title="Xóa phòng">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;

            $('#roomsTable tbody').append(html);
            roomIndex++;

            $('#totalRooms').text($('.room-row').length);

            // Init AutoNumeric cho field mới
            $('.new-money').each(function() {
                new AutoNumeric(this, {
                    digitGroupSeparator: '.',
                    decimalCharacter: ',',
                    decimalPlaces: 0,
                    suffixText: ' đ',
                    minimumValue: '0'
                });
                $(this).removeClass('new-money');
            });
        }

        function removeRoom(roomId, roomName, tenantCount) {
            if (tenantCount > 0) {
                Swal.fire({
                    title: 'Cảnh báo!',
                    html: `Phòng <strong>${roomName}</strong> đang có ${tenantCount} người thuê.<br>
                           Xóa phòng sẽ xóa luôn tất cả người thuê trong phòng.<br>
                           Bạn có chắc chắn muốn xóa?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Xóa phòng',
                    cancelButtonText: 'Hủy'
                }).then((result) => {
                    if (result.isConfirmed) {
                        removeRoomFromTable(roomId, roomName);
                    }
                });
            } else {
                Swal.fire({
                    title: 'Xác nhận xóa?',
                    text: `Bạn muốn xóa phòng ${roomName} khỏi hợp đồng?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Xóa',
                    cancelButtonText: 'Hủy'
                }).then((result) => {
                    if (result.isConfirmed) {
                        removeRoomFromTable(roomId, roomName);
                    }
                });
            }
        }

        function removeRoomFromTable(roomId, roomName) {
            if ($('.room-row').length <= 1) {
                Swal.fire('Không thể xóa', 'Hợp đồng phải có ít nhất 1 phòng', 'error');
                return;
            }

            $(`.room-row[data-room-id="${roomId}"]`).fadeOut(300, function() {
                $(this).remove();
                reindexRooms();
                $('#totalRooms').text($('.room-row').length);
                calculateTotal();

                Swal.fire({
                    icon: 'success',
                    title: 'Đã xóa',
                    text: `Phòng ${roomName} đã được xóa khỏi hợp đồng`,
                    timer: 1500,
                    showConfirmButton: false
                });
            });
        }

        function reindexRooms() {
            $('.room-row').each(function(newIndex) {
                var $row = $(this);
                $row.attr('data-index', newIndex);

                $row.find('input[name*="SelectedRooms"]').each(function() {
                    var name = $(this).attr('name');
                    var newName = name.replace(/\[\d+\]/, '[' + newIndex + ']');
                    $(this).attr('name', newName);
                });
            });

            roomIndex = $('.room-row').length;
        }

        function addTenantToRoom(roomId, roomName) {
            window.location.href = '@Url.Action("ManageTenants", "Rooms")/' + roomId;
        }

        $('#searchRoom').on('input', function() {
            var searchText = $(this).val().toLowerCase();
            $('.list-group-item').each(function() {
                var roomName = $(this).find('label').text().toLowerCase();
                if (roomName.includes(searchText)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });
    </script>
}
