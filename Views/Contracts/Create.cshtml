@model NhaTroAnCu.Models.ContractCreateViewModel

@{
    ViewBag.Title = "Tạo Hợp Đồng Mới";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* Existing styles */
    .contract-form-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .form-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px 15px 0 0;
        text-align: center;
        margin-bottom: 0;
    }

    .form-section {
        background: white;
        padding: 30px;
        margin-bottom: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .section-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
    }

    .contract-type-selector {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }

    .type-card {
        padding: 30px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }

        .type-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .type-card.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .type-card i {
            font-size: 3rem;
            margin-bottom: 15px;
        }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .btn-submit {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 40px;
        border: none;
        border-radius: 25px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

    .hidden {
        display: none;
    }

    /* New styles for tenant management */
    .tenant-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        position: relative;
    }

    .tenant-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .tenant-number {
        background: #667eea;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-weight: 600;
    }

    .btn-remove-tenant {
        background: #dc3545;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
    }

        .btn-remove-tenant:hover {
            background: #c82333;
        }

    .btn-add-tenant {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 10px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

        .btn-add-tenant:hover {
            background: #218838;
        }

    .scan-section {
        background: #f0f8ff;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .tenant-list-container {
        max-height: 600px;
        overflow-y: auto;
        padding-right: 10px;
    }

    .summary-box {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #dee2e6;
    }
</style>

<div class="contract-form-container">
    <div class="form-header">
        <h2><i class="fas fa-file-contract"></i> Tạo Hợp Đồng Thuê Nhà</h2>
        <p>Vui lòng chọn loại khách hàng và điền đầy đủ thông tin</p>
    </div>

    @using (Html.BeginForm("Create", "Contracts", FormMethod.Post, new { @class = "contract-form", enctype = "multipart/form-data" }))
    {
        @Html.AntiForgeryToken()
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

        <!-- Chọn loại hợp đồng -->
        <div class="form-section">
            <div class="section-title">
                <i class="fas fa-users"></i> Loại Khách Hàng
            </div>

            <div class="contract-type-selector">
                <div class="type-card" data-type="Individual">
                    <i class="fas fa-user"></i>
                    <h4>Khách Hàng Cá Nhân</h4>
                    <p>Thuê cho cá nhân/hộ gia đình</p>
                </div>
                <div class="type-card" data-type="Company">
                    <i class="fas fa-building"></i>
                    <h4>Khách Hàng Công Ty</h4>
                    <p>Thuê cho doanh nghiệp/tổ chức</p>
                </div>
            </div>

            @Html.HiddenFor(m => m.ContractType, new { @id = "ContractType" })
        </div>

        <!-- Thông tin chung -->
        <div class="form-section">
            <div class="section-title">
                <i class="fas fa-info-circle"></i> Thông Tin Hợp Đồng
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Ngày bắt đầu <span class="text-danger">*</span></label>
                    @Html.TextBoxFor(m => m.StartDate, new { @class = "form-control", @type = "date" })
                    @Html.ValidationMessageFor(m => m.StartDate, "", new { @class = "text-danger" })
                </div>

                <div class="form-group">
                    <label>Số tháng thuê <span class="text-danger">*</span></label>
                    @Html.TextBoxFor(m => m.Months, new { @class = "form-control", @type = "number", @min = "1", @max = "120" })
                    @Html.ValidationMessageFor(m => m.Months, "", new { @class = "text-danger" })
                </div>

                <div class="form-group">
                    <label>Ngày chuyển vào <span class="text-danger">*</span></label>
                    @Html.TextBoxFor(m => m.MoveInDate, new { @class = "form-control", @type = "date" })
                    @Html.ValidationMessageFor(m => m.MoveInDate, "", new { @class = "text-danger" })
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Giá điện (đ/kWh) <span class="text-danger">*</span></label>
                    @Html.TextBoxFor(m => m.ElectricityPrice, new { @class = "form-control", @type = "number", @step = "100" })
                    @Html.ValidationMessageFor(m => m.ElectricityPrice, "", new { @class = "text-danger" })
                </div>

                <div class="form-group">
                    <label>Giá nước (đ/m³) <span class="text-danger">*</span></label>
                    @Html.TextBoxFor(m => m.WaterPrice, new { @class = "form-control", @type = "number", @step = "1000" })
                    @Html.ValidationMessageFor(m => m.WaterPrice, "", new { @class = "text-danger" })
                </div>

                <div class="form-group">
                    <label>Tiền cọc</label>
                    @Html.TextBoxFor(m => m.DepositAmount, new { @class = "form-control", @type = "number", @step = "100000" })
                </div>
            </div>

            <div class="form-group">
                <label>Ghi chú</label>
                @Html.TextAreaFor(m => m.Note, new { @class = "form-control", @rows = "3" })
            </div>
        </div>

        <!-- Section cho khách hàng cá nhân -->
        <div id="individualSection" class="form-section hidden">
            <div class="section-title">
                <i class="fas fa-user"></i> Thông Tin Người Thuê
            </div>

            <!-- Container cho danh sách người thuê -->
            <div id="tenantListContainer" class="tenant-list-container">
                <!-- Người thuê đầu tiên (mặc định) -->
                <div class="tenant-card" data-tenant-index="0">
                    <div class="tenant-card-header">
                        <span class="tenant-number">Người thuê 1</span>
                        <button type="button" class="btn-remove-tenant" onclick="removeTenant(0)" style="display:none;">
                            <i class="fas fa-trash"></i> Xóa
                        </button>
                    </div>

                    <!-- Phần upload và quét CCCD -->
                    <div class="scan-section">
                        <h5 style="color: #2c3e50; margin-bottom: 15px;">
                            <i class="fas fa-id-card"></i> Quét thông tin từ CCCD/CMND
                        </h5>

                        <div class="form-group">
                            <label>Upload ảnh CCCD/CMND để tự động điền thông tin</label>
                            <input type="file" class="cccd-file form-control" data-tenant-index="0" accept="image/*" />
                            <small class="form-text text-muted">
                                Hỗ trợ định dạng: JPG, PNG, GIF. Hệ thống sẽ tự động nhận diện và điền thông tin.
                            </small>
                        </div>

                        <button type="button" class="btn btn-primary btn-scan-cccd" data-tenant-index="0">
                            <i class="fas fa-qrcode"></i> Quét thông tin CCCD
                        </button>

                        <div class="scan-result hidden" data-tenant-index="0" style="margin-top: 15px;">
                            <!-- Kết quả quét sẽ hiển thị ở đây -->
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Họ và tên <span class="text-danger">*</span></label>
                            <input type="text" name="Tenants[0].FullName" class="form-control tenant-fullname" data-tenant-index="0" />
                        </div>

                        <div class="form-group">
                            <label>Số CCCD/CMND <span class="text-danger">*</span></label>
                            <input type="text" name="Tenants[0].IdentityCard" class="form-control tenant-identity" data-tenant-index="0" />
                        </div>

                        <div class="form-group">
                            <label>Số điện thoại</label>
                            <input type="text" name="Tenants[0].PhoneNumber" class="form-control tenant-phone" data-tenant-index="0" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Ngày sinh</label>
                            <input type="date" name="Tenants[0].BirthDate" class="form-control tenant-birthdate" data-tenant-index="0" />
                        </div>

                        <div class="form-group">
                            <label>Giới tính</label>
                            <select name="Tenants[0].Gender" class="form-control tenant-gender" data-tenant-index="0">
                                <option value="">-- Chọn --</option>
                                <option value="Nam">Nam</option>
                                <option value="Nữ">Nữ</option>
                                <option value="Khác">Khác</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Dân tộc</label>
                            <input type="text" name="Tenants[0].Ethnicity" class="form-control tenant-ethnicity" data-tenant-index="0" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Địa chỉ thường trú</label>
                            <input type="text" name="Tenants[0].PermanentAddress" class="form-control tenant-address" data-tenant-index="0" style="width: 100%;" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Biển số xe</label>
                            <input type="text" name="Tenants[0].VehiclePlate" class="form-control tenant-vehicle" data-tenant-index="0" />
                        </div>

                        <div class="form-group">
                            <label>Ảnh CCCD/Hộ chiếu</label>
                            <input type="file" name="TenantPhotos[0]" class="form-control" accept="image/*" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Nút thêm người thuê -->
            <button type="button" class="btn-add-tenant" onclick="addNewTenant()">
                <i class="fas fa-plus"></i> Thêm người thuê
            </button>
            <small class="form-text text-muted">Tối đa 4 người/phòng</small>

            <!-- Chọn phòng cho hợp đồng cá nhân -->
            <div class="section-title" style="margin-top: 30px;">
                <i class="fas fa-door-open"></i> Chọn Phòng
            </div>

            <div class="form-group">
                <label>Chọn phòng <span class="text-danger">*</span></label>
                @Html.DropDownListFor(m => m.SingleRoomId,
                    new SelectList(ViewBag.AvailableRooms ?? new List<SelectListItem>(), "RoomId", "RoomName"),
                    "-- Chọn phòng --",
                    new { @class = "form-control", @id = "singleRoomSelect" })
            </div>

            <div class="form-group">
                <label>Giá thuê (đ/tháng)</label>
                @Html.TextBoxFor(m => m.SingleRoomPrice, new { @class = "form-control", @type = "number", @id = "singleRoomPrice" })
                <small class="form-text text-muted">Để trống sẽ lấy giá mặc định của phòng</small>
            </div>
        </div>

        <!-- Section cho khách hàng công ty (giữ nguyên) -->
        <div id="companySection" class="form-section hidden">
            <div class="section-title">
                <i class="fas fa-building"></i> Thông Tin Công Ty
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Tên công ty <span class="text-danger">*</span></label>
                    @Html.TextBoxFor(m => m.Company.CompanyName, new { @class = "form-control" })
                </div>

                <div class="form-group">
                    <label>Mã số thuế <span class="text-danger">*</span></label>
                    @Html.TextBoxFor(m => m.Company.TaxCode, new { @class = "form-control" })
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Người đại diện <span class="text-danger">*</span></label>
                    @Html.TextBoxFor(m => m.Company.Representative, new { @class = "form-control" })
                </div>

                <div class="form-group">
                    <label>SĐT người đại diện</label>
                    @Html.TextBoxFor(m => m.Company.RepresentativePhone, new { @class = "form-control" })
                </div>

                <div class="form-group">
                    <label>Email công ty</label>
                    @Html.TextBoxFor(m => m.Company.Email, new { @class = "form-control", @type = "email" })
                </div>
            </div>

            <div class="form-group">
                <label>Địa chỉ công ty</label>
                @Html.TextBoxFor(m => m.Company.Address, new { @class = "form-control" })
            </div>

            <!-- Tổng kết cho công ty -->
            <div class="summary-box">
                <h5>Tổng kết</h5>
                <div class="summary-row">
                    <span>Số phòng đã chọn:</span>
                    <span id="totalRooms">0</span>
                </div>
                <div class="summary-row">
                    <span>Tổng tiền thuê/tháng:</span>
                    <span id="totalRent">0đ</span>
                </div>
            </div>
        </div>

        <!-- Submit buttons -->
        <div class="form-section text-center">
            <button type="submit" class="btn btn-submit">
                <i class="fas fa-save"></i> Tạo Hợp Đồng
            </button>
            <a href="@Url.Action("Index", "Contracts")" class="btn btn-secondary" style="margin-left: 10px;">
                <i class="fas fa-times"></i> Hủy
            </a>
        </div>
    }
</div>

@section Scripts {
    <script>
    // Biến global
    var tenantCount = 1;
    var maxTenants = 4;

    $(document).ready(function() {
        // Xử lý chọn loại hợp đồng
        $('.type-card').click(function() {
            $('.type-card').removeClass('selected');
            $(this).addClass('selected');

            var type = $(this).data('type');
            $('#ContractType').val(type);

            if (type === 'Individual') {
                $('#individualSection').removeClass('hidden');
                $('#companySection').addClass('hidden');
            } else {
                $('#companySection').removeClass('hidden');
                $('#individualSection').addClass('hidden');
            }
        });

        // Xử lý quét CCCD (delegate để hoạt động với elements động)
        $(document).on('click', '.btn-scan-cccd', function() {
            var tenantIndex = $(this).data('tenant-index');
            scanCCCD(tenantIndex);
        });
    });

    // Hàm thêm người thuê mới
    function addNewTenant() {
        if (tenantCount >= maxTenants) {
            alert('Đã đạt giới hạn số người thuê (tối đa ' + maxTenants + ' người/phòng)');
            return;
        }

        var newTenantHtml = `
            <div class="tenant-card" data-tenant-index="${tenantCount}">
                <div class="tenant-card-header">
                    <span class="tenant-number">Người thuê ${tenantCount + 1}</span>
                    <button type="button" class="btn-remove-tenant" onclick="removeTenant(${tenantCount})">
                        <i class="fas fa-trash"></i> Xóa
                    </button>
                </div>

                <div class="scan-section">
                    <h5 style="color: #2c3e50; margin-bottom: 15px;">
                        <i class="fas fa-id-card"></i> Quét thông tin từ CCCD/CMND
                    </h5>

                    <div class="form-group">
                        <label>Upload ảnh CCCD/CMND để tự động điền thông tin</label>
                        <input type="file" class="cccd-file form-control" data-tenant-index="${tenantCount}" accept="image/*" />
                        <small class="form-text text-muted">
                            Hỗ trợ định dạng: JPG, PNG, GIF. Hệ thống sẽ tự động nhận diện và điền thông tin.
                        </small>
                    </div>

                    <button type="button" class="btn btn-primary btn-scan-cccd" data-tenant-index="${tenantCount}">
                        <i class="fas fa-qrcode"></i> Quét thông tin CCCD
                    </button>

                    <div class="scan-result hidden" data-tenant-index="${tenantCount}" style="margin-top: 15px;">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Họ và tên <span class="text-danger">*</span></label>
                        <input type="text" name="Tenants[${tenantCount}].FullName" class="form-control tenant-fullname" data-tenant-index="${tenantCount}" />
                    </div>

                    <div class="form-group">
                        <label>Số CCCD/CMND <span class="text-danger">*</span></label>
                        <input type="text" name="Tenants[${tenantCount}].IdentityCard" class="form-control tenant-identity" data-tenant-index="${tenantCount}" />
                    </div>

                    <div class="form-group">
                        <label>Số điện thoại</label>
                        <input type="text" name="Tenants[${tenantCount}].PhoneNumber" class="form-control tenant-phone" data-tenant-index="${tenantCount}" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Ngày sinh</label>
                        <input type="date" name="Tenants[${tenantCount}].BirthDate" class="form-control tenant-birthdate" data-tenant-index="${tenantCount}" />
                    </div>

                    <div class="form-group">
                        <label>Giới tính</label>
                        <select name="Tenants[${tenantCount}].Gender" class="form-control tenant-gender" data-tenant-index="${tenantCount}">
                            <option value="">-- Chọn --</option>
                            <option value="Nam">Nam</option>
                            <option value="Nữ">Nữ</option>
                            <option value="Khác">Khác</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Dân tộc</label>
                        <input type="text" name="Tenants[${tenantCount}].Ethnicity" class="form-control tenant-ethnicity" data-tenant-index="${tenantCount}" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Địa chỉ thường trú</label>
                        <input type="text" name="Tenants[${tenantCount}].PermanentAddress" class="form-control tenant-address" data-tenant-index="${tenantCount}" style="width: 100%;" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Biển số xe</label>
                        <input type="text" name="Tenants[${tenantCount}].VehiclePlate" class="form-control tenant-vehicle" data-tenant-index="${tenantCount}" />
                    </div>

                    <div class="form-group">
                        <label>Ảnh CCCD/Hộ chiếu</label>
                        <input type="file" name="TenantPhotos[${tenantCount}]" class="form-control" accept="image/*" />
                    </div>
                </div>
            </div>
        `;

        $('#tenantListContainer').append(newTenantHtml);
        tenantCount++;
        updateRemoveButtons();
    }

    // Hàm xóa người thuê
    function removeTenant(index) {
        if (tenantCount <= 1) {
            alert('Phải có ít nhất 1 người thuê');
            return;
        }

        // Xóa tenant card
        $(`.tenant-card[data-tenant-index="${index}"]`).remove();
        tenantCount--;

        // Cập nhật lại index và tên cho các tenant còn lại
        reindexTenants();
        updateRemoveButtons();
    }

    // Cập nhật lại index cho các tenant
    function reindexTenants() {
        $('.tenant-card').each(function(newIndex) {
            var $card = $(this);
            var oldIndex = $card.data('tenant-index');

            // Cập nhật data-tenant-index
            $card.attr('data-tenant-index', newIndex);

            // Cập nhật số thứ tự hiển thị
            $card.find('.tenant-number').text('Người thuê ' + (newIndex + 1));

            // Cập nhật nút xóa
            $card.find('.btn-remove-tenant').attr('onclick', `removeTenant(${newIndex})`);

            // Cập nhật tất cả các input names và data attributes
            $card.find('input, select').each(function() {
                var $input = $(this);
                var name = $input.attr('name');
                if (name) {
                    // Thay thế index trong name attribute
                    var newName = name.replace(/\[\d+\]/, `[${newIndex}]`);
                    $input.attr('name', newName);
                }

                // Cập nhật data-tenant-index
                if ($input.data('tenant-index') !== undefined) {
                    $input.attr('data-tenant-index', newIndex);
                }
            });

            // Cập nhật các elements khác có data-tenant-index
            $card.find('[data-tenant-index]').each(function() {
                $(this).attr('data-tenant-index', newIndex);
            });
        });
    }

    // Cập nhật hiển thị nút xóa
    function updateRemoveButtons() {
        if (tenantCount <= 1) {
            $('.btn-remove-tenant').hide();
        } else {
            $('.btn-remove-tenant').show();
        }
    }

    // Hàm quét CCCD
    function scanCCCD(tenantIndex) {
        var fileInput = $(`.cccd-file[data-tenant-index="${tenantIndex}"]`)[0];

        if (!fileInput.files || !fileInput.files[0]) {
            alert('Vui lòng chọn file ảnh CCCD!');
            return;
        }

        var formData = new FormData();
        formData.append('image', fileInput.files[0]);

        var $btn = $(`.btn-scan-cccd[data-tenant-index="${tenantIndex}"]`);
        var $result = $(`.scan-result[data-tenant-index="${tenantIndex}"]`);

        // Hiển thị loading
        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Đang quét...');
        $result.removeClass('hidden success partial error').html('Đang xử lý ảnh...');

        // Gọi API quét CCCD
        $.ajax({
            url: '@Url.Action("ScanCCCD", "FPTReader")',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                $btn.prop('disabled', false).html('<i class="fas fa-qrcode"></i> Quét thông tin CCCD');

                if (response.success) {
                    // Điền thông tin vào form của tenant tương ứng
                    if (response.data.name) {
                        $(`.tenant-fullname[data-tenant-index="${tenantIndex}"]`).val(response.data.name);
                    }
                    if (response.data.id) {
                        $(`.tenant-identity[data-tenant-index="${tenantIndex}"]`).val(response.data.id);
                    }
                    if (response.data.dob) {
                        // Convert định dạng ngày từ dd/MM/yyyy sang yyyy-MM-dd
                        var parts = response.data.dob.split('/');
                        if (parts.length === 3) {
                            var formattedDate = parts[2] + '-' + parts[1].padStart(2, '0') + '-' + parts[0].padStart(2, '0');
                            $(`.tenant-birthdate[data-tenant-index="${tenantIndex}"]`).val(formattedDate);
                        }
                    }
                    if (response.data.sex) {
                        $(`.tenant-gender[data-tenant-index="${tenantIndex}"]`).val(response.data.sex);
                    }
                    if (response.data.home) {
                        $(`.tenant-address[data-tenant-index="${tenantIndex}"]`).val(response.data.home);
                    }
                    if (response.data.ethnicity) {
                        $(`.tenant-ethnicity[data-tenant-index="${tenantIndex}"]`).val(response.data.ethnicity);
                    }

                    $result.addClass('success').html(
                        '<i class="fas fa-check-circle"></i> Quét thành công! Thông tin đã được điền vào form.'
                    );
                } else if (response.data) {
                    // Quét thành công một phần
                    var fieldsFound = [];
                    if (response.data.name) fieldsFound.push('Họ tên');
                    if (response.data.id) fieldsFound.push('Số CCCD');
                    if (response.data.dob) fieldsFound.push('Ngày sinh');
                    if (response.data.home) fieldsFound.push('Địa chỉ');

                    $result.addClass('partial').html(
                        '<i class="fas fa-info-circle"></i> Đã nhận diện được: ' + fieldsFound.join(', ') +
                        '. Vui lòng kiểm tra và bổ sung thông tin còn thiếu.'
                    );
                } else {
                    $result.addClass('error').html(
                        '<i class="fas fa-exclamation-triangle"></i> Không thể nhận diện thông tin. Vui lòng nhập thủ công.'
                    );
                }
            },
            error: function() {
                $btn.prop('disabled', false).html('<i class="fas fa-qrcode"></i> Quét thông tin CCCD');
                $result.addClass('error').html(
                    '<i class="fas fa-exclamation-triangle"></i> Lỗi kết nối. Vui lòng thử lại sau.'
                );
            }
        });
    }

    // CSS cho scan results
    var style = document.createElement('style');
    style.innerHTML = `
        .scan-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 5px;
        }

        .scan-result.partial {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            padding: 10px;
            border-radius: 5px;
        }

        .scan-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 5px;
        }
    `;
    document.head.appendChild(style);
    </script>
}